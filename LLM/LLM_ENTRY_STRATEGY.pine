//@version=6
// LLM Entry Strategy - Pine Script Representation
// 
// NOT: Bu Pine Script, LLM projesinin giriş kriterlerini gösterir.
// Gerçek model prediction Pine Script'te yapılamaz (Transformer model gerektirir),
// ama giriş mantığı ve kriterleri burada gösterilmiştir.

strategy("LLM Entry Strategy", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================================================
// CONFIGURATION (LLM configs/llm_config.json'dan)
// ============================================================================
thr_long = input.float(0.75, "Long Threshold", minval=0.0, maxval=1.0, step=0.01, group="Model Thresholds", tooltip="Gerçek sistemde 0.85, Pine Script'te 0.75 daha gerçekçi")
thr_short = input.float(0.75, "Short Threshold", minval=0.0, maxval=1.0, step=0.01, group="Model Thresholds", tooltip="Gerçek sistemde 0.85, Pine Script'te 0.75 daha gerçekçi")
tp_pct = input.float(0.008, "Take Profit %", minval=0.001, maxval=0.1, step=0.001, group="Risk Management")
sl_pct = input.float(0.008, "Stop Loss %", minval=0.001, maxval=0.1, step=0.001, group="Risk Management")

// Regime Filter (şu anda disabled)
regime_enabled = input.bool(false, "Regime Filter Enabled", group="Regime Filter")
use_ema_filter = input.bool(false, "Use EMA Filter", group="Regime Filter")
use_vol_filter = input.bool(false, "Use Volume Filter", group="Regime Filter")
vol_spike_threshold = input.float(0.4, "Volume Spike Threshold", minval=0.0, maxval=5.0, step=0.1, group="Regime Filter")

// ============================================================================
// FEATURES (LLM/src/features.py'dan)
// ============================================================================
// Bu feature'lar model tarafından kullanılıyor (128 bar window)
// Pine Script'te tam olarak hesaplanamaz ama mantığı gösteriyoruz

// EMA'lar
ema10 = ta.ema(close, 10)
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)

// EMA distances (relative)
ema10_dist = (close - ema10) / close
ema20_dist = (close - ema20) / close
ema50_dist = (close - ema50) / close
ema200_dist = (close - ema200) / close

// EMA slopes (3-bar change)
ema10_slope = (ema10 - ema10[3]) / ema10
ema20_slope = (ema20 - ema20[3]) / ema20
ema50_slope = (ema50 - ema50[3]) / ema50
ema200_slope = (ema200 - ema200[3]) / ema200

// RSI
rsi = ta.rsi(close, 14)

// Volume spike (volume / rolling mean 20)
vol_mean_20 = ta.sma(volume, 20)
vol_spike = volume / vol_mean_20

// Log returns
log_ret = math.log(close / close[1])
log_ret_3 = math.sum(log_ret, 3)
log_ret_5 = math.sum(log_ret, 5)

// HL range and body
hl_range = high - low
body = math.abs(close - open)
hl_range_norm = hl_range / close
body_norm = body / close

// Upper/lower wick ratios
upper_wick = high - math.max(open, close)
lower_wick = math.min(open, close) - low
upper_wick_ratio = hl_range > 0 ? upper_wick / hl_range : 0
lower_wick_ratio = hl_range > 0 ? lower_wick / hl_range : 0

// ============================================================================
// MODEL PREDICTION (SIMULATED - IMPROVED)
// ============================================================================
// NOT: Gerçek model prediction Pine Script'te yapılamaz.
// Burada daha iyi bir proxy gösteriyoruz (gerçek model Transformer kullanıyor).
// Gerçek sistemde model 128 bar window'dan feature'ları alıp prediction yapar.

// İyileştirilmiş proxy: Trend + Momentum + Volume + Price Action kombinasyonu
// Bu proxy, gerçek modelin davranışını daha iyi simüle eder

// 1. TREND ANALYSIS (EMA alignment)
trend_strength = 0.0
trend_direction = 0  // 1 = uptrend, -1 = downtrend, 0 = neutral

if ema10 > ema20 and ema20 > ema50 and ema50 > ema200
    trend_strength := 0.4  // Strong uptrend
    trend_direction := 1
else if ema10 < ema20 and ema20 < ema50 and ema50 < ema200
    trend_strength := 0.4  // Strong downtrend
    trend_direction := -1
else if ema50 > ema200
    trend_strength := 0.2  // Weak uptrend
    trend_direction := 1
else if ema50 < ema200
    trend_strength := 0.2  // Weak downtrend
    trend_direction := -1

// 2. MOMENTUM ANALYSIS (RSI + Price momentum)
momentum_score = 0.0
if rsi > 70
    momentum_score := -0.15  // Overbought - bearish momentum
else if rsi < 30
    momentum_score := 0.15   // Oversold - bullish momentum
else if rsi > 55
    momentum_score := 0.1    // Bullish momentum
else if rsi < 45
    momentum_score := -0.1   // Bearish momentum

// Price momentum (close vs EMA)
price_momentum = (close - ema20) / ema20
momentum_score := momentum_score + (price_momentum * 2.0)

// 3. VOLUME ANALYSIS
volume_score = 0.0
if vol_spike > 1.5
    volume_score := 0.15  // Strong volume
else if vol_spike > 1.2
    volume_score := 0.1   // Good volume
else if vol_spike > 1.0
    volume_score := 0.05  // Normal volume
else
    volume_score := -0.05 // Low volume (negative signal)

// 4. PRICE ACTION (Candle patterns)
price_action_score = 0.0
body_ratio = body / hl_range
if body_ratio > 0.7 and close > open
    price_action_score := 0.1  // Strong bullish candle
else if body_ratio > 0.7 and close < open
    price_action_score := -0.1 // Strong bearish candle

// 5. COMBINED SCORE
// Trend direction'a göre score'u yönlendir
base_score = momentum_score + volume_score + price_action_score

// combined_score'u önce tanımla (Pine Script scope gereksinimi)
float combined_score = 0.0

// Trend ile uyumlu ise score'u artır, uyumsuz ise azalt
if trend_direction == 1  // Uptrend
    combined_score := base_score + trend_strength
    // Uptrend'de long için pozitif, short için negatif
else if trend_direction == -1  // Downtrend
    combined_score := base_score - trend_strength
    // Downtrend'de short için pozitif, long için negatif
else
    combined_score := base_score  // Neutral trend

// 6. PROBABILITY CALCULATION
// Sigmoid-like transformation to get probabilities
// Gerçek model softmax kullanıyor, burada basitleştirilmiş versiyon

// Long probability (trend uptrend ise daha yüksek)
prob_long_base = math.max(0, combined_score)
if trend_direction == -1
    prob_long_base := prob_long_base * 0.3  // Downtrend'de long prob düşük
else if trend_direction == 1
    prob_long_base := prob_long_base * 1.5  // Uptrend'de long prob yüksek

// Short probability (trend downtrend ise daha yüksek)
prob_short_base = math.max(0, -combined_score)
if trend_direction == 1
    prob_short_base := prob_short_base * 0.3  // Uptrend'de short prob düşük
else if trend_direction == -1
    prob_short_base := prob_short_base * 1.5  // Downtrend'de short prob yüksek

// Flat probability (belirsizlik)
prob_flat_base = 1.0 - math.abs(combined_score)

// Normalize to sum to 1.0
total_prob = prob_long_base + prob_short_base + prob_flat_base + 0.1  // Add small base
prob_long = (prob_long_base + 0.05) / total_prob
prob_short = (prob_short_base + 0.05) / total_prob
prob_flat = (prob_flat_base + 0.05) / total_prob

// Ensure probabilities sum to 1.0
total_check = prob_long + prob_short + prob_flat
prob_long := prob_long / total_check
prob_short := prob_short / total_check
prob_flat := prob_flat / total_check

// ============================================================================
// DECISION LOGIC (LLM/src/infer.py - decide_side)
// ============================================================================
// Gerçek sistemde: decide_side(probs, thr_long, thr_short)
side = "FLAT"
confidence = prob_flat

if prob_long >= thr_long
    side := "LONG"
    confidence := prob_long
else if prob_short >= thr_short
    side := "SHORT"
    confidence := prob_short

// ============================================================================
// REGIME FILTER (LLM/scripts/run_live_continuous.py)
// ============================================================================
// ÖNEMLİ: Gerçek sistemde regime filter disabled, ama trend kontrolü ekliyoruz
// Çünkü piyasa short iken long açmak mantıksız!

regime_ok = true

// Trend kontrolü (her zaman aktif - mantıklı olması için)
// Piyasa bearish ise long açma, bullish ise short açma
trend_check = true
if side == "LONG"
    // Long için: EMA50 > EMA200 olmalı (uptrend)
    trend_check := ema50 > ema200
    if not trend_check
        // Trend bearish ama long sinyali var - bu mantıksız, reddet
        regime_ok := false
else if side == "SHORT"
    // Short için: EMA50 < EMA200 olmalı (downtrend)
    trend_check := ema50 < ema200
    if not trend_check
        // Trend bullish ama short sinyali var - bu mantıksız, reddet
        regime_ok := false

// Opsiyonel regime filter (config'den kontrol)
if regime_enabled
    if use_ema_filter
        // Zaten yukarıda kontrol edildi
        regime_ok := regime_ok and trend_check
    
    if use_vol_filter
        regime_ok := regime_ok and (vol_spike > vol_spike_threshold)

// ============================================================================
// ENTRY CONDITIONS
// ============================================================================
// Final entry condition
can_enter_long = (side == "LONG") and regime_ok
can_enter_short = (side == "SHORT") and regime_ok

// ============================================================================
// TP/SL CALCULATION (LLM/src/infer.py - tp_sl_from_pct)
// ============================================================================
tp_price_long = close * (1 + tp_pct)
sl_price_long = close * (1 - sl_pct)
tp_price_short = close * (1 - tp_pct)
sl_price_short = close * (1 + sl_pct)

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================
if can_enter_long and strategy.position_size == 0
    strategy.entry("LONG", strategy.long, comment="LLM LONG")
    strategy.exit("TP_LONG", "LONG", limit=tp_price_long, stop=sl_price_long, comment="TP/SL")

if can_enter_short and strategy.position_size == 0
    strategy.entry("SHORT", strategy.short, comment="LLM SHORT")
    strategy.exit("TP_SHORT", "SHORT", limit=tp_price_short, stop=sl_price_short, comment="TP/SL")

// ============================================================================
// VISUALIZATION
// ============================================================================
// Plot EMAs
plot(ema10, "EMA 10", color=color.blue, linewidth=1)
plot(ema20, "EMA 20", color=color.orange, linewidth=1)
plot(ema50, "EMA 50", color=color.yellow, linewidth=2)
plot(ema200, "EMA 200", color=color.red, linewidth=2)

// Plot signals
plotshape(can_enter_long, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="LONG Signal")
plotshape(can_enter_short, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="SHORT Signal")

// Plot TP/SL levels
plot(strategy.position_size > 0 ? tp_price_long : na, "TP Long", color=color.green, linewidth=1, style=plot.style_line)
plot(strategy.position_size > 0 ? sl_price_long : na, "SL Long", color=color.red, linewidth=1, style=plot.style_line)
plot(strategy.position_size < 0 ? tp_price_short : na, "TP Short", color=color.green, linewidth=1, style=plot.style_line)
plot(strategy.position_size < 0 ? sl_price_short : na, "SL Short", color=color.red, linewidth=1, style=plot.style_line)

// ============================================================================
// TABLE: Model Probabilities
// ============================================================================
var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.white, border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "Metric", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, bgcolor=color.gray)
    
    table.cell(info_table, 0, 1, "Prob Long", text_color=color.black)
    table.cell(info_table, 1, 1, str.tostring(prob_long, "#.##%"), text_color=prob_long >= thr_long ? color.green : color.black)
    
    table.cell(info_table, 0, 2, "Prob Short", text_color=color.black)
    table.cell(info_table, 1, 2, str.tostring(prob_short, "#.##%"), text_color=prob_short >= thr_short ? color.red : color.black)
    
    table.cell(info_table, 0, 3, "Prob Flat", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(prob_flat, "#.##%"), text_color=color.black)
    
    table.cell(info_table, 0, 4, "Side", text_color=color.black)
    table.cell(info_table, 1, 4, side, text_color=side == "LONG" ? color.green : (side == "SHORT" ? color.red : color.gray))
    
    table.cell(info_table, 0, 5, "Confidence", text_color=color.black)
    table.cell(info_table, 1, 5, str.tostring(confidence, "#.##%"), text_color=color.black)

// ============================================================================
// NOTES
// ============================================================================
// 1. Bu Pine Script, LLM projesinin giriş mantığını gösterir.
// 2. Gerçek model prediction Pine Script'te yapılamaz (Transformer model gerektirir).
// 3. Burada gösterilen "prob_long", "prob_short", "prob_flat" sadece proxy'dir.
// 4. Gerçek sistemde:
//    - Model 128 bar window'dan feature'ları alır
//    - Transformer model ile prediction yapar
//    - Threshold kontrolü yapılır (thr_long >= 0.85, thr_short >= 0.85)
//    - Regime filter kontrol edilir (şu anda disabled)
//    - Pattern blocker kontrol edilir
//    - Volume spike monitor kontrol edilir
// 5. Gerçek model eğitilmiş bir Transformer'dır ve Python'da çalışır.
// 6. Bu Pine Script sadece görselleştirme ve anlama amaçlıdır.

