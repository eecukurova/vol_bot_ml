//@version=5
strategy("PENGU Head & Shoulders Pattern", shorttitle="PENGU H&S", overlay=true,
         initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.1)

// ============================================================================
// PENGU HEAD & SHOULDERS PATTERN STRATEGY
// Test Results: +34.36% return (Hourly), +32.14% return (Daily)
// ============================================================================

// Inputs
pattern_lookback = input.int(15, title="Pattern Lookback", minval=5, maxval=30)
tp_pct = input.float(10.0, title="Take Profit %", minval=1, maxval=50)
sl_pct = input.float(5.0, title="Stop Loss %", minval=1, maxval=20)

// Price arrays for pattern detection
var float[] left_highs = array.new<float>()
var float[] right_highs = array.new<float>()
var float[] left_lows = array.new<float>()
var float[] right_lows = array.new<float>()

// Head & Shoulders Detection (Bearish - Sell Signal)
var bool hs_detected = false
if bar_index >= pattern_lookback * 3
    // Left shoulder
    left_high = ta.highest(high[pattern_lookback * 2], pattern_lookback)
    // Head
    head = ta.highest(high[pattern_lookback], pattern_lookback)
    // Right shoulder
    right_high = ta.highest(high, pattern_lookback)
    
    // Neckline
    neckline = (ta.lowest(low[pattern_lookback * 2], pattern_lookback) + ta.lowest(low, pattern_lookback)) / 2
    
    // Pattern validation
    if head > left_high and head > right_high
        if math.abs(left_high - right_high) / head < 0.1
            hs_detected := true
        else
            hs_detected := false
    else
        hs_detected := false

// Inverse Head & Shoulders Detection (Bullish - Buy Signal)
var bool ihs_detected = false
if bar_index >= pattern_lookback * 3
    // Left shoulder
    left_low = ta.lowest(low[pattern_lookback * 2], pattern_lookback)
    // Head
    head = ta.lowest(low[pattern_lookback], pattern_lookback)
    // Right shoulder
    right_low = ta.lowest(low, pattern_lookback)
    
    // Neckline
    neckline = (ta.highest(high[pattern_lookback * 2], pattern_lookback) + ta.highest(high, pattern_lookback)) / 2
    
    // Pattern validation
    if head < left_low and head < right_low
        if math.abs(left_low - right_low) / math.abs(head) < 0.1
            ihs_detected := true
        else
            ihs_detected := false
    else
        ihs_detected := false

// Signals
buy_signal = ihs_detected and not ihs_detected[1]
sell_signal = hs_detected and not hs_detected[1]

// Strategy
var float entry_price = na

// Entry
if buy_signal and strategy.position_size == 0
    entry_price := close
    strategy.entry("Long", strategy.long, comment="Inverse H&S")

// Exit
if strategy.position_size > 0 and not na(entry_price)
    current_return = ((close - entry_price) / entry_price) * 100
    
    // TP
    if current_return >= tp_pct
        strategy.close("Long", comment="TP")
        entry_price := na
    // SL
    else if current_return <= -sl_pct
        strategy.close("Long", comment="SL")
        entry_price := na

// Sell signal exit
if sell_signal and strategy.position_size > 0
    strategy.close("Long", comment="Head & Shoulders")
    entry_price := na

// Plotting
plotshape(buy_signal, title="Buy", location=location.belowbar, 
          color=color.green, style=shape.triangleup)
plotshape(sell_signal, title="Sell", location=location.abovebar, 
          color=color.red, style=shape.triangledown)

