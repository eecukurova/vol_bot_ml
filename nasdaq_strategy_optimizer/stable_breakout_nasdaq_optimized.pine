//@version=6

strategy("Stable Breakout Strategy â€” NASDAQ Optimized",
     overlay=true, 
     commission_type=strategy.commission.percent, 
     commission_value=0.05,
     initial_capital=100000, 
     pyramiding=0,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=10)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUTS - Optimized from Real Backtest (NVDA/TSLA Best Results)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Breakout Parameters (Optimized: lenHigh 30, minRise 1.0% for more trades)
lenHigh   = input.int(30, "Highest Lookback (bars)", minval=2, maxval=200, group="ğŸ“Š Breakout")
minRise   = input.float(1.0, "Min Rise from Open (%)", step=0.1, minval=0.1, maxval=10.0, group="ğŸ“Š Breakout")

// Volume Parameters (Optimized: lenVol 15, volKatsay 1.0 for more trades)
lenVol    = input.int(15, "Volume SMA (bars)", minval=1, maxval=100, group="ğŸ“ˆ Volume")
volKatsay = input.float(1.0, "Volume x SMA Multiplier", step=0.1, minval=0.5, maxval=3.0, group="ğŸ“ˆ Volume")

// RSI Filter (Optional - Disabled by default for more trades)
useRSI    = input.bool(false, "Use RSI Filter", group="ğŸ” Filters")
rsiLen    = input.int(14, "RSI Period", minval=2, maxval=50, group="ğŸ” Filters")
rsiMin    = input.float(40.0, "Min RSI", step=0.5, minval=0, maxval=100, group="ğŸ” Filters")
rsiMax    = input.float(70.0, "Max RSI", step=0.5, minval=0, maxval=100, group="ğŸ” Filters")

// EMA Trend Filter (Optional)
useEMA    = input.bool(false, "Use EMA Trend Filter", group="ğŸ” Filters")
emaLen    = input.int(50, "EMA Period", minval=2, maxval=200, group="ğŸ” Filters")

// Risk Management (Optimized: TP 2.5%, SL 2.0% from backtest)
useTP_SL  = input.bool(true, "Use TP/SL", group="ğŸ›¡ï¸ Risk Management")
tpPct     = input.float(2.5, "Take Profit (%)", step=0.1, minval=0.1, maxval=20.0, group="ğŸ›¡ï¸ Risk Management")
slPct     = input.float(2.0, "Stop Loss (%)", step=0.1, minval=0.1, maxval=10.0, group="ğŸ›¡ï¸ Risk Management")

// Visual Settings
showHighLine = input.bool(true, "Show Highest Line", group="ğŸ¨ Visual")
showEMA      = input.bool(true, "Show EMA Line", group="ğŸ¨ Visual")
showMarks    = input.bool(true, "Show Entry Marks & Labels", group="ğŸ¨ Visual")
showTable    = input.bool(true, "Show Info Table", group="ğŸ¨ Visual")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Price and Volume
c = close
o = open
h = high
l = low
v = volume

// Highest Price (excluding current bar)
highestN_raw = ta.highest(h, lenHigh)
highestN     = highestN_raw[1]  // Previous bar's highest

// Volume SMA
smaVol = ta.sma(v, lenVol)

// RSI
rsi = ta.rsi(c, rsiLen)

// EMA Trend
ema = ta.ema(c, emaLen)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL CONDITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Core Breakout Conditions
cond1_breakout = c > highestN                                    // Price breaks highest
cond2_momentum = ((c - o) / math.max(o, 0.0000001)) * 100 >= minRise  // Minimum rise %
cond3_volume  = v > smaVol * volKatsay                           // Volume spike

// Additional Filters
cond4_rsi = not useRSI or (rsi >= rsiMin and rsi <= rsiMax)      // RSI in range
cond5_ema = not useEMA or c > ema                                // Price above EMA

// Combined Signal
signalLong = cond1_breakout and cond2_momentum and cond3_volume and cond4_rsi and cond5_ema

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRATEGY LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Entry
if signalLong and strategy.position_size <= 0
    strategy.entry("LONG", strategy.long, comment="Breakout")

// Exit with TP/SL
if useTP_SL and strategy.position_size > 0
    avgPrice = strategy.position_avg_price
    slPrice  = avgPrice * (1 - slPct / 100.0)
    tpPrice  = avgPrice * (1 + tpPct / 100.0)
    strategy.exit("L-TP/SL", from_entry="LONG", stop=slPrice, limit=tpPrice, comment="TP/SL")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISUALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Plot Highest Line
plot(showHighLine ? highestN : na, 
     title="Highest Line", 
     linewidth=2, 
     color=color.new(color.blue, 0),
     style=plot.style_line)

// Plot EMA
plot(showEMA and useEMA ? ema : na, 
     title="EMA Trend", 
     linewidth=1, 
     color=color.new(color.orange, 0),
     style=plot.style_line)

// Bar Color
barcolor(signalLong ? color.new(color.lime, 0) : na)

// Entry Marker
plotshape(showMarks and signalLong, 
          title="LONG Signal",
          style=shape.triangleup, 
          location=location.belowbar,
          size=size.small, 
          text="LONG", 
          textcolor=color.white,
          color=color.new(color.green, 0))

// Entry Label
if showMarks and signalLong
    labelText = "Breakout\nHighest(" + str.tostring(lenHigh) + ")\nRise: " + str.tostring(minRise, "#.#") + "%"
    label.new(bar_index, low, 
              labelText,
              style=label.style_label_up, 
              textcolor=color.white, 
              color=color.new(color.green, 0),
              size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INFO TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if showTable and barstate.islast
    var table infoTable = table.new(position.top_right, 2, 8, 
                                    bgcolor=color.new(color.black, 80), 
                                    border_width=1)
    
    // Header
    table.cell(infoTable, 0, 0, "Parameter", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, text_size=size.small)
    
    // Highest
    table.cell(infoTable, 0, 1, "Highest(" + str.tostring(lenHigh) + ")", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(highestN, "#.##"), text_color=color.white, text_size=size.small)
    
    // Current Price
    table.cell(infoTable, 0, 2, "Current Price", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(c, "#.##"), text_color=color.white, text_size=size.small)
    
    // RSI
    if useRSI
        table.cell(infoTable, 0, 3, "RSI(" + str.tostring(rsiLen) + ")", text_color=color.white, text_size=size.small)
        rsiColor = rsi >= rsiMin and rsi <= rsiMax ? color.green : color.red
        table.cell(infoTable, 1, 3, str.tostring(rsi, "#.#"), text_color=rsiColor, text_size=size.small)
    
    // Volume
    volRatio = v / smaVol
    table.cell(infoTable, 0, 4, "Volume Ratio", text_color=color.white, text_size=size.small)
    volColor = volRatio >= volKatsay ? color.green : color.red
    table.cell(infoTable, 1, 4, str.tostring(volRatio, "#.##") + "x", text_color=volColor, text_size=size.small)
    
    // Rise %
    risePct = ((c - o) / o) * 100
    table.cell(infoTable, 0, 5, "Rise %", text_color=color.white, text_size=size.small)
    riseColor = risePct >= minRise ? color.green : color.red
    table.cell(infoTable, 1, 5, str.tostring(risePct, "#.##") + "%", text_color=riseColor, text_size=size.small)
    
    // Signal Status
    table.cell(infoTable, 0, 6, "Signal", text_color=color.white, text_size=size.small)
    signalColor = signalLong ? color.green : color.gray
    signalText = signalLong ? "LONG âœ…" : "None"
    table.cell(infoTable, 1, 6, signalText, text_color=signalColor, text_size=size.small)
    
    // Position
    posSize = strategy.position_size
    table.cell(infoTable, 0, 7, "Position", text_color=color.white, text_size=size.small)
    if posSize > 0
        table.cell(infoTable, 1, 7, "LONG " + str.tostring(posSize, "#.##"), text_color=color.green, text_size=size.small)
    else
        table.cell(infoTable, 1, 7, "None", text_color=color.gray, text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(signalLong, 
               title="Breakout Long Signal", 
               message="ğŸš€ Breakout Long Signal\n{{ticker}}\nPrice: {{close}}\nVolume: {{volume}}")

