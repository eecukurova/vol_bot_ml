//@version=4
strategy(title="ONDO ATR SuperTrend 15m Ultra Selective", overlay = true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ============================================================================
// INPUT PARAMETERS - ONDO USDT 15M ULTRA SELECTIVE
// ============================================================================

// ATR Parameters - Ultra Selective for ONDO
atr_period = input.int(20, "ATR Period", minval=14, maxval=30)
atr_multiplier = input.float(3.0, "ATR Key Value (Sensitivity)", minval=2.5, maxval=4.0, step=0.1)
supertrend_multiplier = input.float(1.5, "SuperTrend Multiplier", minval=1.2, maxval=2.0, step=0.1)

// Heikin Ashi Option
use_heikin_ashi = input.bool(true, "Use Heikin Ashi Candles")

// Risk Management - Ultra Tight for ONDO
stop_loss_pct = input.float(1.2, "Stop Loss (%)", minval=0.8, maxval=2.0, step=0.1) / 100
take_profit_pct = input.float(2.0, "Take Profit (%)", minval=1.5, maxval=3.0, step=0.1) / 100
trailing_stop = input.bool(true, "Enable Trailing Stop")
trailing_percent = input.float(0.6, "Trailing Stop (%)", minval=0.4, maxval=1.0, step=0.1) / 100

// Volume Filter - Ultra Selective
use_volume_filter = input.bool(true, "Use Volume Filter")
volume_multiplier = input.float(1.8, "Volume Multiplier", minval=1.5, maxval=2.5, step=0.1)

// Timeframe Filter - Only best hours
use_timeframe_filter = input.bool(true, "Use Timeframe Filter")
start_hour = input.int(8, "Start Hour (UTC)", minval=0, maxval=23)
end_hour = input.int(20, "End Hour (UTC)", minval=0, maxval=23)

// RSI Filter - Ultra Selective
use_rsi_filter = input.bool(true, "Use RSI Filter")
rsi_period = input.int(21, "RSI Period", minval=14, maxval=30)
rsi_oversold = input.int(40, "RSI Oversold", minval=30, maxval=50)
rsi_overbought = input.int(60, "RSI Overbought", minval=50, maxval=70)

// Trend Filter - Additional confirmation
use_trend_filter = input.bool(true, "Use Trend Filter")
trend_period = input.int(50, "Trend MA Period", minval=30, maxval=100)

// ============================================================================
// ATR SUPER TREND CALCULATIONS
// ============================================================================

// ATR calculation
xATR = atr(atr_period)
nLoss = atr_multiplier * xATR

// Source (Heikin Ashi or Regular)
src = use_heikin_ashi ? security(heikinashi(syminfo.tickerid), timeframe.period, close, lookahead = false) : close

// ATR Trailing Stop calculation
xATRTrailingStop = 0.0
xATRTrailingStop := iff(src > nz(xATRTrailingStop[1], 0) and src[1] > nz(xATRTrailingStop[1], 0), max(nz(xATRTrailingStop[1]), src - nLoss),
   iff(src < nz(xATRTrailingStop[1], 0) and src[1] < nz(xATRTrailingStop[1], 0), min(nz(xATRTrailingStop[1]), src + nLoss), 
   iff(src > nz(xATRTrailingStop[1], 0), src - nLoss, src + nLoss)))

// Position calculation
pos = 0   
pos := iff(src[1] < nz(xATRTrailingStop[1], 0) and src > nz(xATRTrailingStop[1], 0), 1,
   iff(src[1] > nz(xATRTrailingStop[1], 0) and src < nz(xATRTrailingStop[1], 0), -1, nz(pos[1], 0))) 

// SuperTrend calculation
superTrend = xATR * supertrend_multiplier
trendUp = hl2 - superTrend
trendDown = hl2 + superTrend

var float superTrendLine = na
superTrendLine := na(superTrendLine[1]) ? na : (close > superTrendLine[1] ? max(trendUp, superTrendLine[1]) : min(trendDown, superTrendLine[1]))
superTrendLine := na(superTrendLine) ? na : (close > superTrendLine ? trendDown : trendUp)

// ============================================================================
// FILTERS
// ============================================================================

// Volume filter
volume_condition = not use_volume_filter or volume > ta.sma(volume, 20) * volume_multiplier

// Timeframe filter
timeframe_condition = not use_timeframe_filter or (hour >= start_hour and hour <= end_hour)

// RSI filter
rsi = ta.rsi(src, rsi_period)
rsi_condition_long = not use_rsi_filter or (rsi > rsi_oversold and rsi < rsi_overbought)
rsi_condition_short = not use_rsi_filter or (rsi > rsi_oversold and rsi < rsi_overbought)

// Trend filter
trend_ma = ta.sma(src, trend_period)
trend_condition_long = not use_trend_filter or src > trend_ma
trend_condition_short = not use_trend_filter or src < trend_ma

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// ATR signals
ema_fast = ta.ema(src, 1)
above_crossover = ta.crossover(ema_fast, xATRTrailingStop)
below_crossover = ta.crossover(xATRTrailingStop, ema_fast)

buy_atr = src > xATRTrailingStop and above_crossover
sell_atr = src < xATRTrailingStop and below_crossover

// SuperTrend signals
buy_supertrend = ta.crossover(close, superTrendLine)
sell_supertrend = ta.crossunder(close, superTrendLine)

// Combined signals with filters
long_signal = (buy_atr or buy_supertrend) and volume_condition and timeframe_condition and rsi_condition_long and trend_condition_long
short_signal = (sell_atr or sell_supertrend) and volume_condition and timeframe_condition and rsi_condition_short and trend_condition_short

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Entry conditions
if long_signal
    strategy.entry("Long", strategy.long)

if short_signal
    strategy.entry("Short", strategy.short)

// Exit conditions with tight risk management
if strategy.position_size > 0
    strategy.exit("Exit Long", from_entry="Long", 
                 stop=strategy.position_avg_price * (1 - stop_loss_pct), 
                 limit=strategy.position_avg_price * (1 + take_profit_pct))
    
    // Trailing stop
    if trailing_stop
        strategy.exit("Trail Long", from_entry="Long", 
                     trail_price=strategy.position_avg_price * (1 + trailing_percent), 
                     trail_offset=strategy.position_avg_price * trailing_percent)

if strategy.position_size < 0
    strategy.exit("Exit Short", from_entry="Short", 
                 stop=strategy.position_avg_price * (1 + stop_loss_pct), 
                 limit=strategy.position_avg_price * (1 - take_profit_pct))
    
    // Trailing stop
    if trailing_stop
        strategy.exit("Trail Short", from_entry="Short", 
                     trail_price=strategy.position_avg_price * (1 - trailing_percent), 
                     trail_offset=strategy.position_avg_price * trailing_percent)

// ============================================================================
// PLOTTING
// ============================================================================

// Plot SuperTrend line
plot(superTrendLine, color=color.blue, linewidth=2, title="SuperTrend")

// Plot ATR Trailing Stop
plot(xATRTrailingStop, color=color.red, linewidth=1, title="ATR Trailing Stop")

// Plot signals
plotshape(long_signal, title="Long Signal", text="LONG", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, size=size.small)
plotshape(short_signal, title="Short Signal", text="SHORT", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, size=size.small)

// Background color for trend
bgcolor(pos == 1 ? color.new(color.green, 95) : pos == -1 ? color.new(color.red, 95) : na, title="Trend Background")

// Alerts
alertcondition(long_signal, title="Long Alert", message="ONDO Long Signal")
alertcondition(short_signal, title="Short Alert", message="ONDO Short Signal")
