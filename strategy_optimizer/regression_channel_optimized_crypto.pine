//@version=6
strategy("Volensy – Regresyon Kanalları (Optimized for Crypto)", 
     overlay = true,
     initial_capital = 100000,
     commission_type = strategy.commission.percent,
     commission_value = 0.05,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 10,
     pyramiding = 0,
     margin_long = 100,
     margin_short = 100)

//═══════════════════════════════════════════════
// OPTIMIZED PARAMETERS FOR CRYPTO
//═══════════════════════════════════════════════
// Optimized on: 2025-11-23
// Test Results (90 days BTCUSDT 15m):
//   Win Rate: 56.7%
//   Profit Factor: 1.28
//   Return: 13.3%
//   Max Drawdown: 5.0%
//   Total Trades: 97

//═══════════════════════════════════════════════
// 1) GENEL AYARLAR
//═══════════════════════════════════════════════
marketMode = input.string("KRIPTO", "Piyasa Modu", options = ["BIST", "KRIPTO"], group="Genel")
isBist  = marketMode == "BIST"
isKrpto = not isBist

//═══════════════════════════════════════════════
// 2) GİRDİLER - OPTIMIZED FOR CRYPTO
//═══════════════════════════════════════════════
// Regresyon Kanalı
regLen      = input.int(75, "Regresyon Periyodu", minval = 10, group = "Regresyon Kanalı")
innerMult   = input.float(1.0, "İç Bant StdDev Katsayısı", step = 0.1, group = "Regresyon Kanalı")
outerMultB  = input.float(2.0, "Dış Bant StdDev (BIST)",   step = 0.1, group = "Regresyon Kanalı")
outerMultK  = input.float(1.8, "Dış Bant StdDev (KRIPTO) - OPTIMIZED", step = 0.1, group = "Regresyon Kanalı")

// Trend Filtresi
useTrendFilterInput = input.bool(false, "Trend Filtresi (SMA) Kullan (BIST için)", group = "Trend Filtresi")
smaLen              = input.int(14, "SMA Uzunluğu", minval = 1, group = "Trend Filtresi")

// Volatilite Osilatörü (Stoch benzeri) - OPTIMIZED
stochLen    = input.int(10, "Volatilite Osilatörü Periyodu - OPTIMIZED", minval = 3, group = "Volatilite Osilatörü")
smoothK     = input.int(2,  "K Yumuşatma - OPTIMIZED", minval = 1, group = "Volatilite Osilatörü")
smoothD     = input.int(2,  "D Yumuşatma - OPTIMIZED", minval = 1, group = "Volatilite Osilatörü")
obLevelB    = input.float(80.0, "Aşırı Alım (BIST)",   minval = 50, maxval = 100, step = 1, group = "Volatilite Osilatörü")
osLevelB    = input.float(20.0, "Aşırı Satım (BIST)",  minval = 0,  maxval = 50,  step = 1, group = "Volatilite Osilatörü")
obLevelK    = input.float(70.0, "Aşırı Alım (KRIPTO) - OPTIMIZED", minval = 50, maxval = 100, step = 1, group = "Volatilite Osilatörü")
osLevelK    = input.float(20.0, "Aşırı Satım (KRIPTO) - OPTIMIZED", minval = 0,  maxval = 50,  step = 1, group = "Volatilite Osilatörü")

// Sinyal Ayarları
showBgZones = input.bool(true, "Aşırı ALIM/SATIM Bölgelerini Boya", group = "Görsellik")
showLabels  = input.bool(true, "AL / SAT Şekillerini Göster", group = "Görsellik")

// Mod'a göre türetilen parametreler
outerMult   = isBist ? outerMultB : outerMultK
obLevel     = isBist ? obLevelB   : obLevelK
osLevel     = isBist ? osLevelB   : osLevelK
useTrendFilter = isBist and useTrendFilterInput   // Kripto modunda daima kapalı

//═══════════════════════════════════════════════
// 3) REGRESYON KANALI HESAPLARI
//═══════════════════════════════════════════════
// Regresyon (denge hattı)
regressionLine = ta.linreg(close, regLen, 0)

// StdDev
regDev = ta.stdev(close, regLen)

// İç bantlar
upperInner = regressionLine + regDev * innerMult
lowerInner = regressionLine - regDev * innerMult

// Dış bantlar (aşırı alım / aşırı satım bölgeleri)
upperOuter = regressionLine + regDev * outerMult
lowerOuter = regressionLine - regDev * outerMult

//═══════════════════════════════════════════════
// 4) TREND FİLTRESİ (SMA)
//═══════════════════════════════════════════════
sma = ta.sma(close, smaLen)

// Trend koşulu (mod'a göre opsiyonel)
bullTrend = not useTrendFilter or close > sma
bearTrend = not useTrendFilter or close < sma

//═══════════════════════════════════════════════
// 5) VOLATİLİTE OSİLATÖRÜ (STOCH BENZERİ)
//═══════════════════════════════════════════════
// %K ve %D
kRaw = ta.stoch(high, low, close, stochLen)
k    = ta.sma(kRaw, smoothK)
d    = ta.sma(k, smoothD)

// Osilatör çizimleri (aynı pencerede)
plot(k, title = "Volatilite Osilatörü %K", linewidth = 2, color = color.blue)
plot(d, title = "Volatilite Osilatörü %D", linewidth = 1, color = color.orange)
hline(obLevel, "Aşırı Alım",  linestyle = hline.style_dotted, color = color.red)
hline(osLevel, "Aşırı Satım", linestyle = hline.style_dotted, color = color.green)

//═══════════════════════════════════════════════
// 6) AŞIRI ALIM / AŞIRI SATIM GÖRSEL BÖLGELER
//═══════════════════════════════════════════════
bgCol = showBgZones ? (close > upperOuter ? color.new(color.red, 85) : close < lowerOuter ? color.new(color.green, 85) : na) : na
bgcolor(bgCol)

// Regresyon ve SMA çizimleri
plot(regressionLine, title = "Regresyon Orta Hat", color = color.new(color.gray, 0), linewidth = 2)
plot(sma,            title = "SMA",                color = color.new(color.orange, 0), linewidth = 2)
plot(upperInner, title = "İç Üst Bant",  color = color.new(color.red, 60),   linewidth = 1)
plot(lowerInner, title = "İç Alt Bant",  color = color.new(color.green, 60), linewidth = 1)
plot(upperOuter, title = "Dış Üst Bant", color = color.new(color.red, 0),    linewidth = 2, style = plot.style_linebr)
plot(lowerOuter, title = "Dış Alt Bant", color = color.new(color.green, 0),  linewidth = 2, style = plot.style_linebr)

//═══════════════════════════════════════════════
// 7) SİNYAL KOŞULLARI (MODE-BASED)
//═══════════════════════════════════════════════
// 1) Fiyat aşırı uçta mı?
inExtremeLow  = close <= lowerOuter
inExtremeHigh = close >= upperOuter

// 2) Volatilite osilatörü – mod'a göre farklı
// BIST → seviye cross
volBuyB  = k < osLevel and ta.crossover(k, osLevel)
volSellB = k > obLevel and ta.crossunder(k, obLevel)

// KRIPTO → K ve D kesişimi, seviye yalnızca filtre
volBuyK  = k < osLevel and ta.crossover(k, d)
volSellK = k > obLevel and ta.crossunder(k, d)

// Aktif vol sinyali
volBuy  = isBist ? volBuyB  : volBuyK
volSell = isBist ? volSellB : volSellK

// Nihai AL / SAT koşulları
buyCond  = inExtremeLow  and bullTrend and volBuy
sellCond = inExtremeHigh and bearTrend and volSell

//═══════════════════════════════════════════════
// 8) STRATEJİ EMİRLERİ
//═══════════════════════════════════════════════
// Long giriş
if buyCond and barstate.isconfirmed
    if strategy.position_size < 0
        strategy.close("Short")
    strategy.entry("Long", strategy.long)

// Short giriş
if sellCond and barstate.isconfirmed
    if strategy.position_size > 0
        strategy.close("Long")
    strategy.entry("Short", strategy.short)

//═══════════════════════════════════════════════
// 9) GRAFİKTE İŞARETLER
//═══════════════════════════════════════════════
plotshape(showLabels and buyCond,
     title     = "AL",
     text      = "AL",
     style     = shape.triangleup,
     location  = location.belowbar,
     color     = color.lime,
     size      = size.large)

plotshape(showLabels and sellCond,
     title     = "SAT",
     text      = "SAT",
     style     = shape.triangledown,
     location  = location.abovebar,
     color     = color.red,
     size      = size.large)

//═══════════════════════════════════════════════
// 10) PERFORMANS BİLGİLERİ (Grafik üzerinde)
//═══════════════════════════════════════════════
var table perfTable = table.new(position.top_right, 2, 5, bgcolor = color.white, border_width = 1)
if barstate.islast
    table.cell(perfTable, 0, 0, "Metric", text_color = color.black, bgcolor = color.gray)
    table.cell(perfTable, 1, 0, "Value", text_color = color.black, bgcolor = color.gray)
    
    table.cell(perfTable, 0, 1, "Win Rate", text_color = color.black)
    table.cell(perfTable, 1, 1, str.tostring(strategy.wintrades / math.max(strategy.closedtrades, 1) * 100, "#.##") + "%", text_color = color.black)
    
    table.cell(perfTable, 0, 2, "Profit Factor", text_color = color.black)
    table.cell(perfTable, 1, 2, str.tostring(strategy.grossprofit / math.max(strategy.grossloss, 1), "#.##"), text_color = color.black)
    
    table.cell(perfTable, 0, 3, "Total Return", text_color = color.black)
    table.cell(perfTable, 1, 3, str.tostring(strategy.netprofit / strategy.initial_capital * 100, "#.##") + "%", text_color = color.black)
    
    table.cell(perfTable, 0, 4, "Total Trades", text_color = color.black)
    table.cell(perfTable, 1, 4, str.tostring(strategy.closedtrades), text_color = color.black)

