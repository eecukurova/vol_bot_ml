//@version=6
strategy("4H TWMA Zaman Ağırlıklı Trend Stratejisi - BTC Optimized",
     overlay = true,
     initial_capital = 100000,
     commission_type = strategy.commission.percent,
     commission_value = 0.05,
     pyramiding = 0,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 10)

//────────────────────────────────────────────
// INPUTLAR - BTCUSDT 4H OPTİMİZE EDİLMİŞ PARAMETRELER
//────────────────────────────────────────────
// Optimizasyon Sonuçları (Score: 128.46):
// - Total Trades: 70
// - Win Rate: 44.29%
// - Profit Factor: 1.50
// - Total Return: 10.75% (5x leverage)
// - Max Drawdown: 5.50%
// - Avg Win: 12.33% | Avg Loss: -6.54%

groupTwma = "TWMA (Zaman Ağırlıklı Ortalama)"
twmaLen   = input.int(15, "TWMA Periyodu", minval = 2, maxval = 200, group = groupTwma, tooltip = "Optimize edilmiş: 15")

groupRisk = "Risk / Ödül (ATR Bazlı)"
atrLen    = input.int(14, "ATR Periyodu", minval = 1, group = groupRisk, tooltip = "Optimize edilmiş: 14")
slAtrMult = input.float(1.0, "Stop: ATR Katsayısı", step = 0.1, group = groupRisk, tooltip = "Optimize edilmiş: 1.0× ATR")
tpAtrMult = input.float(1.5, "TP: ATR Katsayısı", step = 0.1, group = groupRisk, tooltip = "Optimize edilmiş: 1.5× ATR")

groupSwing = "Swing (Son Tepe / Son Dip)"
pivotLen   = input.int(3, "Pivot Sol/Sağ Mum Sayısı", minval = 2, maxval = 20, group = groupSwing, tooltip = "Optimize edilmiş: 3")

//────────────────────────────────────────────
// ZAMAN AĞIRLIKLI HAREKETLİ ORTALAMA (TWMA)
//────────────────────────────────────────────
f_twma(src, length) =>
    float num = 0.0
    float den = 0.0
    for i = 0 to length - 1
        float w = (length - i)
        num += src[i] * w
        den += w
    num / den

twma = f_twma(close, twmaLen)

// TWMA yönü
twmaUp   = twma > twma[1]
twmaDown = twma < twma[1]

// ATR
atr = ta.atr(atrLen)

//────────────────────────────────────────────
// SON TEPE / SON DİP
//────────────────────────────────────────────
var float lastSwingHigh = na
var float lastSwingLow  = na
ph = ta.pivothigh(high, pivotLen, pivotLen)
pl = ta.pivotlow(low,  pivotLen, pivotLen)

if not na(ph)
    lastSwingHigh := ph
if not na(pl)
    lastSwingLow := pl

//────────────────────────────────────────────
// SİNYAL KOŞULLARI
//────────────────────────────────────────────
// TWMA testi (iğne)
touchLongNow  = low  <= twma and close >= twma
touchShortNow = high >= twma and close <= twma

// Setup bar (önceki mum)
setupLongBar  = close > twma and twmaUp
setupShortBar = close < twma and twmaDown

// Pozisyonsuz olma kontrolü
noPos = strategy.position_size == 0

// Giriş: iğneden sonraki kapanış
longEntryCond  = setupLongBar[1]  and touchLongNow[1]  and noPos
shortEntryCond = setupShortBar[1] and touchShortNow[1] and noPos

//────────────────────────────────────────────
// STOP & TP HESABI (TWMA ± ATR)
//────────────────────────────────────────────
var float longSL  = na
var float longTP  = na
var float shortSL = na
var float shortTP = na

// LONG GİRİŞ
if longEntryCond
    float baseTwma = twma
    float slPrice  = baseTwma - slAtrMult * atr
    float tpBase   = na(lastSwingHigh) ? baseTwma : lastSwingHigh
    float tpPrice  = tpBase + tpAtrMult * atr
    
    longSL := slPrice
    longTP := tpPrice
    
    strategy.entry("Long", strategy.long)

// SHORT GİRİŞ
if shortEntryCond
    float baseTwmaS = twma
    float slPriceS  = baseTwmaS + slAtrMult * atr
    float tpBaseS   = na(lastSwingLow) ? baseTwmaS : lastSwingLow
    float tpPriceS  = tpBaseS - tpAtrMult * atr
    
    shortSL := slPriceS
    shortTP := tpPriceS
    
    strategy.entry("Short", strategy.short)

// Çıkış emirleri
if strategy.position_size > 0 and not na(longSL) and not na(longTP)
    strategy.exit("Long Exit", "Long", stop = longSL, limit = longTP)
if strategy.position_size < 0 and not na(shortSL) and not na(shortTP)
    strategy.exit("Short Exit", "Short", stop = shortSL, limit = shortTP)

//────────────────────────────────────────────
// GÖRSEL: TWMA, TP/SL, SİNYAL İŞARETLERİ
//────────────────────────────────────────────
twmaColor = twmaUp ? color.new(color.lime, 0) : twmaDown ? color.new(color.red, 0) : color.new(color.orange, 0)

plot(twma, "TWMA (Zaman Ağırlıklı Ortalama)", twmaColor, 2)

// SL / TP çizgileri
plot(strategy.position_size > 0 ? longSL  : na, "Long SL",  color.new(color.red, 60), 1, plot.style_linebr)
plot(strategy.position_size > 0 ? longTP  : na, "Long TP",  color.new(color.green, 60), 1, plot.style_linebr)
plot(strategy.position_size < 0 ? shortSL : na, "Short SL", color.new(color.red, 60), 1, plot.style_linebr)
plot(strategy.position_size < 0 ? shortTP : na, "Short TP", color.new(color.green, 60), 1, plot.style_linebr)

// Giriş işaretleri
plotshape(longEntryCond,   title = "Long Entry",  style = shape.triangleup,  location = location.belowbar, color = color.lime,  size = size.small, text = "LONG")
plotshape(shortEntryCond, title = "Short Entry", style = shape.triangledown, location = location.abovebar, color = color.red,   size = size.small, text = "SHORT")

// Arka plan renk
bgcolor(strategy.position_size > 0 ? color.new(color.green, 92) :
        strategy.position_size < 0 ? color.new(color.red, 92)   : na)

//────────────────────────────────────────────
// PERFORMANS BİLGİLERİ (Table)
//────────────────────────────────────────────
var table perfTable = table.new(position.top_right, 2, 8, bgcolor = color.new(color.black, 80), border_width = 1)

if barstate.islast
    table.cell(perfTable, 0, 0, "Optimize Edilmiş", text_color = color.white, text_size = size.small)
    table.cell(perfTable, 1, 0, "BTCUSDT 4H", text_color = color.yellow, text_size = size.small)
    
    table.cell(perfTable, 0, 1, "TWMA:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 1, str.tostring(twmaLen), text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 2, "ATR:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 2, str.tostring(atrLen), text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 3, "SL:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 3, str.tostring(slAtrMult) + "× ATR", text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 4, "TP:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 4, str.tostring(tpAtrMult) + "× ATR", text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 5, "Pivot:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 5, str.tostring(pivotLen), text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 6, "Backtest:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 6, "Score: 128.46", text_color = color.lime, text_size = size.small)
    
    table.cell(perfTable, 0, 7, "Return:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 7, "+10.75%", text_color = color.lime, text_size = size.small)

