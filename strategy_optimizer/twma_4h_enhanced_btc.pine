//@version=6
strategy("4H TWMA Zaman Ağırlıklı Trend Stratejisi - BTC Enhanced (Filtreli)",
     overlay = true,
     initial_capital = 100000,
     commission_type = strategy.commission.percent,
     commission_value = 0.05,
     pyramiding = 0,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 10)

//────────────────────────────────────────────
// INPUTLAR - BTCUSDT 4H OPTİMİZE EDİLMİŞ PARAMETRELER + FİLTRELER
//────────────────────────────────────────────
// Optimizasyon Sonuçları (Enhanced - Filtreli):
// - Total Trades: 56
// - Win Rate: 53.57% (Önceki: 44.29%) ⭐
// - Profit Factor: 2.22 (Önceki: 1.50) ⭐
// - Total Return: 14.24% (Önceki: 10.75%) ⭐
// - Max Drawdown: 4.19% (Önceki: 5.50%) ⭐
// - Filtered Signals: 68/124 (54.8%)

groupTwma = "TWMA (Zaman Ağırlıklı Ortalama)"
twmaLen   = input.int(15, "TWMA Periyodu", minval = 2, maxval = 200, group = groupTwma, tooltip = "Optimize edilmiş: 15")

groupRisk = "Risk / Ödül (ATR Bazlı)"
atrLen    = input.int(14, "ATR Periyodu", minval = 1, group = groupRisk, tooltip = "Optimize edilmiş: 14")
slAtrMult = input.float(1.0, "Stop: ATR Katsayısı", step = 0.1, group = groupRisk, tooltip = "Optimize edilmiş: 1.0× ATR")
tpAtrMult = input.float(1.5, "TP: ATR Katsayısı", step = 0.1, group = groupRisk, tooltip = "Optimize edilmiş: 1.5× ATR")

groupSwing = "Swing (Son Tepe / Son Dip)"
pivotLen   = input.int(3, "Pivot Sol/Sağ Mum Sayısı", minval = 2, maxval = 20, group = groupSwing, tooltip = "Optimize edilmiş: 3")

//────────────────────────────────────────────
// FİLTRELER (Win Rate Artırıcı)
//────────────────────────────────────────────
groupFilters = "Filtreler (Win Rate Artırıcı)"
useRsiFilter = input.bool(true, "RSI Filtresi", group = groupFilters, tooltip = "Aşırı alım/satım bölgelerinden kaçın")
rsiLen = input.int(14, "RSI Periyodu", minval = 1, group = groupFilters)
rsiOversold = input.int(35, "RSI Oversold", minval = 0, maxval = 50, group = groupFilters, tooltip = "Optimize: 35")
rsiOverbought = input.int(65, "RSI Overbought", minval = 50, maxval = 100, group = groupFilters, tooltip = "Optimize: 65")

useMacdFilter = input.bool(true, "MACD Filtresi", group = groupFilters, tooltip = "Trend momentum doğrulama")
macdFast = input.int(12, "MACD Fast", minval = 1, group = groupFilters)
macdSlow = input.int(26, "MACD Slow", minval = 1, group = groupFilters)
macdSignal = input.int(9, "MACD Signal", minval = 1, group = groupFilters)

useVolumeFilter = input.bool(true, "Volume Filtresi", group = groupFilters, tooltip = "Düşük hacimli sinyalleri filtrele")
volumeMaLen = input.int(20, "Volume MA Periyodu", minval = 1, group = groupFilters)
volumeMultiplier = input.float(1.0, "Volume Çarpanı", step = 0.1, group = groupFilters, tooltip = "Optimize: 1.0×")

useEmaFilter = input.bool(false, "EMA Trend Filtresi", group = groupFilters, tooltip = "EMA trend filtresi (optimize edilmiş: kapalı)")
emaFast = input.int(12, "EMA Fast", minval = 1, group = groupFilters)
emaSlow = input.int(26, "EMA Slow", minval = 1, group = groupFilters)

useAdxFilter = input.bool(true, "ADX Trend Gücü Filtresi", group = groupFilters, tooltip = "Güçlü trend olan sinyalleri seç")
adxLen = input.int(14, "ADX Periyodu", minval = 1, group = groupFilters)
adxThreshold = input.int(20, "ADX Minimum Değer", minval = 0, maxval = 100, group = groupFilters, tooltip = "Optimize: ≥20")

//────────────────────────────────────────────
// ZAMAN AĞIRLIKLI HAREKETLİ ORTALAMA (TWMA)
//────────────────────────────────────────────
f_twma(src, length) =>
    float num = 0.0
    float den = 0.0
    for i = 0 to length - 1
        float w = (length - i)
        num += src[i] * w
        den += w
    num / den

twma = f_twma(close, twmaLen)

// TWMA yönü
twmaUp   = twma > twma[1]
twmaDown = twma < twma[1]

// ATR
atr = ta.atr(atrLen)

//────────────────────────────────────────────
// FİLTRE İNDİKATÖRLERİ
//────────────────────────────────────────────
// RSI
rsi = ta.rsi(close, rsiLen)

// MACD
macdLine = ta.ema(close, macdFast) - ta.ema(close, macdSlow)
macdSignalLine = ta.ema(macdLine, macdSignal)
macdHist = macdLine - macdSignalLine

// Volume MA
volumeMa = ta.sma(volume, volumeMaLen)

// EMA
emaFastLine = ta.ema(close, emaFast)
emaSlowLine = ta.ema(close, emaSlow)

// ADX
[diplus, diminus, adx] = ta.dmi(adxLen, adxLen)

//────────────────────────────────────────────
// SON TEPE / SON DİP
//────────────────────────────────────────────
var float lastSwingHigh = na
var float lastSwingLow  = na
ph = ta.pivothigh(high, pivotLen, pivotLen)
pl = ta.pivotlow(low,  pivotLen, pivotLen)

if not na(ph)
    lastSwingHigh := ph
if not na(pl)
    lastSwingLow := pl

//────────────────────────────────────────────
// FİLTRE KONTROLLERİ
//────────────────────────────────────────────
// Long için filtreler
checkFiltersLong() =>
    filtersPassed = 0
    totalFilters = 0
    
    // RSI Filter - Long için: RSI aşırı alımda olmamalı
    if useRsiFilter
        totalFilters += 1
        if rsi < rsiOverbought
            filtersPassed += 1
    
    // MACD Filter - Long için: MACD > Signal ve histogram pozitif
    if useMacdFilter
        totalFilters += 1
        if macdLine > macdSignalLine and macdHist > 0
            filtersPassed += 1
    
    // Volume Filter - Long için: Volume ortalamanın üzerinde olmalı
    if useVolumeFilter
        totalFilters += 1
        if volume > volumeMa * volumeMultiplier
            filtersPassed += 1
    
    // EMA Filter - Long için: Fast EMA > Slow EMA
    if useEmaFilter
        totalFilters += 1
        if emaFastLine > emaSlowLine
            filtersPassed += 1
    
    // ADX Filter - Trend gücü yeterli olmalı
    if useAdxFilter
        totalFilters += 1
        if adx >= adxThreshold
            filtersPassed += 1
    
    // En az %60 filtre geçmeli
    totalFilters == 0 or filtersPassed >= (totalFilters * 0.6)

// Short için filtreler
checkFiltersShort() =>
    filtersPassed = 0
    totalFilters = 0
    
    // RSI Filter - Short için: RSI aşırı satımda olmamalı
    if useRsiFilter
        totalFilters += 1
        if rsi > rsiOversold
            filtersPassed += 1
    
    // MACD Filter - Short için: MACD < Signal ve histogram negatif
    if useMacdFilter
        totalFilters += 1
        if macdLine < macdSignalLine and macdHist < 0
            filtersPassed += 1
    
    // Volume Filter - Short için: Volume ortalamanın üzerinde olmalı
    if useVolumeFilter
        totalFilters += 1
        if volume > volumeMa * volumeMultiplier
            filtersPassed += 1
    
    // EMA Filter - Short için: Fast EMA < Slow EMA
    if useEmaFilter
        totalFilters += 1
        if emaFastLine < emaSlowLine
            filtersPassed += 1
    
    // ADX Filter - Trend gücü yeterli olmalı
    if useAdxFilter
        totalFilters += 1
        if adx >= adxThreshold
            filtersPassed += 1
    
    // En az %60 filtre geçmeli
    totalFilters == 0 or filtersPassed >= (totalFilters * 0.6)

//────────────────────────────────────────────
// SİNYAL KOŞULLARI
//────────────────────────────────────────────
// TWMA testi (iğne)
touchLongNow  = low  <= twma and close >= twma
touchShortNow = high >= twma and close <= twma

// Setup bar (önceki mum)
setupLongBar  = close > twma and twmaUp
setupShortBar = close < twma and twmaDown

// Pozisyonsuz olma kontrolü
noPos = strategy.position_size == 0

// Giriş: iğneden sonraki kapanış
baseLongEntryCond  = setupLongBar[1]  and touchLongNow[1]  and noPos
baseShortEntryCond = setupShortBar[1] and touchShortNow[1] and noPos

// Filtrelerle giriş koşulları
longEntryCond  = baseLongEntryCond  and checkFiltersLong()
shortEntryCond = baseShortEntryCond and checkFiltersShort()

//────────────────────────────────────────────
// STOP & TP HESABI (TWMA ± ATR)
//────────────────────────────────────────────
var float longSL  = na
var float longTP  = na
var float shortSL = na
var float shortTP = na

// LONG GİRİŞ
if longEntryCond
    float baseTwma = twma
    float slPrice  = baseTwma - slAtrMult * atr
    float tpBase   = na(lastSwingHigh) ? baseTwma : lastSwingHigh
    float tpPrice  = tpBase + tpAtrMult * atr
    
    longSL := slPrice
    longTP := tpPrice
    
    strategy.entry("Long", strategy.long)

// SHORT GİRİŞ
if shortEntryCond
    float baseTwmaS = twma
    float slPriceS  = baseTwmaS + slAtrMult * atr
    float tpBaseS   = na(lastSwingLow) ? baseTwmaS : lastSwingLow
    float tpPriceS  = tpBaseS - tpAtrMult * atr
    
    shortSL := slPriceS
    shortTP := tpPriceS
    
    strategy.entry("Short", strategy.short)

// Çıkış emirleri
if strategy.position_size > 0 and not na(longSL) and not na(longTP)
    strategy.exit("Long Exit", "Long", stop = longSL, limit = longTP)
if strategy.position_size < 0 and not na(shortSL) and not na(shortTP)
    strategy.exit("Short Exit", "Short", stop = shortSL, limit = shortTP)

//────────────────────────────────────────────
// GÖRSEL: TWMA, TP/SL, SİNYAL İŞARETLERİ
//────────────────────────────────────────────
twmaColor = twmaUp ? color.new(color.lime, 0) : twmaDown ? color.new(color.red, 0) : color.new(color.orange, 0)

plot(twma, "TWMA (Zaman Ağırlıklı Ortalama)", twmaColor, 2)

// SL / TP çizgileri
plot(strategy.position_size > 0 ? longSL  : na, "Long SL",  color.new(color.red, 60), 1, plot.style_linebr)
plot(strategy.position_size > 0 ? longTP  : na, "Long TP",  color.new(color.green, 60), 1, plot.style_linebr)
plot(strategy.position_size < 0 ? shortSL : na, "Short SL", color.new(color.red, 60), 1, plot.style_linebr)
plot(strategy.position_size < 0 ? shortTP : na, "Short TP", color.new(color.green, 60), 1, plot.style_linebr)

// Giriş işaretleri
plotshape(longEntryCond,   title = "Long Entry",  style = shape.triangleup,  location = location.belowbar, color = color.lime,  size = size.small, text = "LONG")
plotshape(shortEntryCond, title = "Short Entry", style = shape.triangledown, location = location.abovebar, color = color.red,   size = size.small, text = "SHORT")

// Filtrelenmiş sinyaller (görselleştirme)
plotshape(baseLongEntryCond and not longEntryCond,  title = "Filtered Long",  style = shape.xcross, location = location.belowbar, color = color.new(color.orange, 50), size = size.tiny)
plotshape(baseShortEntryCond and not shortEntryCond, title = "Filtered Short", style = shape.xcross, location = location.abovebar, color = color.new(color.orange, 50), size = size.tiny)

// Arka plan renk
bgcolor(strategy.position_size > 0 ? color.new(color.green, 92) :
        strategy.position_size < 0 ? color.new(color.red, 92)   : na)

//────────────────────────────────────────────
// PERFORMANS BİLGİLERİ (Table)
//────────────────────────────────────────────
var table perfTable = table.new(position.top_right, 2, 10, bgcolor = color.new(color.black, 80), border_width = 1)

if barstate.islast
    table.cell(perfTable, 0, 0, "Enhanced", text_color = color.white, text_size = size.small)
    table.cell(perfTable, 1, 0, "BTCUSDT 4H", text_color = color.yellow, text_size = size.small)
    
    table.cell(perfTable, 0, 1, "TWMA:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 1, str.tostring(twmaLen), text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 2, "ATR:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 2, str.tostring(atrLen), text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 3, "SL:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 3, str.tostring(slAtrMult) + "× ATR", text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 4, "TP:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 4, str.tostring(tpAtrMult) + "× ATR", text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 5, "Pivot:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 5, str.tostring(pivotLen), text_color = color.white, text_size = size.small)
    
    table.cell(perfTable, 0, 6, "Filters:", text_color = color.gray, text_size = size.small)
    filterCount = (useRsiFilter ? 1 : 0) + (useMacdFilter ? 1 : 0) + (useVolumeFilter ? 1 : 0) + (useEmaFilter ? 1 : 0) + (useAdxFilter ? 1 : 0)
    table.cell(perfTable, 1, 6, str.tostring(filterCount) + " Active", text_color = color.lime, text_size = size.small)
    
    table.cell(perfTable, 0, 7, "Backtest:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 7, "WR: 53.57%", text_color = color.lime, text_size = size.small)
    
    table.cell(perfTable, 0, 8, "Return:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 8, "+14.24%", text_color = color.lime, text_size = size.small)
    
    table.cell(perfTable, 0, 9, "PF:", text_color = color.gray, text_size = size.small)
    table.cell(perfTable, 1, 9, "2.22", text_color = color.lime, text_size = size.small)

