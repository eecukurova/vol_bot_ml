//@version=6
// ARB Optimized VWMA Strategy - Simple and Clean
// Gerçek veri ile optimize edilmiş parametreler
// Best Result: VWMA=25, RSI=30/70, TP=0.6%, SL=0.5%, Trail=0.3%/0.3%
// Win Rate: 74.65%, Profit Factor: 8.42, Return: 54,650% (5x leverage)

strategy("ARB VWMA Optimized (Simple)", 
     overlay = true,
     initial_capital = 10000,
     commission_type = strategy.commission.percent,
     commission_value = 0.04,
     pyramiding = 0,
     default_qty_type = strategy.percent_of_equity,
     default_qty_value = 100,
     calc_on_order_fills = true,
     process_orders_on_close = true)

// =====================
// INPUTS
// =====================
vwma_len = input.int(25, "VWMA Length", minval=1, group="Entry Parameters")
rsi_len = input.int(14, "RSI Length", minval=1, group="Entry Parameters")
rsi_oversold = input.int(30, "RSI Oversold", minval=0, maxval=50, group="Entry Parameters")
rsi_overbought = input.int(70, "RSI Overbought", minval=50, maxval=100, group="Entry Parameters")
ema_fast_len = input.int(12, "EMA Fast", minval=1, group="Entry Parameters")
ema_slow_len = input.int(26, "EMA Slow", minval=1, group="Entry Parameters")
volume_ma_len = input.int(20, "Volume MA Length", minval=1, group="Entry Parameters")
volume_threshold = input.float(1.2, "Volume Threshold", minval=1.0, step=0.1, group="Entry Parameters")

tp_pct = input.float(1.0, "Take Profit (%)", minval=0.1, step=0.1, group="Exit Parameters", tooltip="✅ Optimized: 1.0%")
sl_pct = input.float(0.5, "Stop Loss (%)", minval=0.1, step=0.1, group="Exit Parameters", tooltip="✅ Optimized: 0.5% (Risk/Reward: 1:0.5)")
trailing_activation_pct = input.float(0.5, "Trailing Activation (%)", minval=0.1, step=0.1, group="Exit Parameters")
trailing_distance_pct = input.float(0.5, "Trailing Distance (%)", minval=0.1, step=0.1, group="Exit Parameters")

// =====================
// INDICATORS
// =====================
vwma = ta.vwma(close, vwma_len)
rsi = ta.rsi(close, rsi_len)
ema_fast = ta.ema(close, ema_fast_len)
ema_slow = ta.ema(close, ema_slow_len)
volume_ma = ta.sma(volume, volume_ma_len)

// =====================
// PLOTS
// =====================
plot(vwma, "VWMA", color=color.new(color.blue, 0), linewidth=2)
plot(ema_fast, "EMA Fast", color=color.new(color.green, 0), linewidth=1)
plot(ema_slow, "EMA Slow", color=color.new(color.red, 0), linewidth=1)

// =====================
// ENTRY CONDITIONS
// =====================
vwma_long = close > vwma
rsi_long = rsi < rsi_overbought and rsi > rsi_oversold
ema_long = ema_fast > ema_slow
volume_long = volume > volume_ma * volume_threshold
long_cond = vwma_long and rsi_long and ema_long and volume_long and strategy.position_size == 0

vwma_short = close < vwma
rsi_short = rsi > rsi_oversold and rsi < rsi_overbought
ema_short = ema_fast < ema_slow
volume_short = volume > volume_ma * volume_threshold
short_cond = vwma_short and rsi_short and ema_short and volume_short and strategy.position_size == 0

// =====================
// TRAILING STOP LOGIC
// =====================
var float trailing_stop_long = na
var float trailing_stop_short = na
var bool trailing_activated_long = false
var bool trailing_activated_short = false

// Calculate profit
current_profit_long = strategy.position_size > 0 ? ((close - strategy.position_avg_price) / strategy.position_avg_price) * 100 : 0
current_profit_short = strategy.position_size < 0 ? ((strategy.position_avg_price - close) / strategy.position_avg_price) * 100 : 0

// LONG Trailing Stop
if strategy.position_size > 0
    if not trailing_activated_long and current_profit_long >= trailing_activation_pct
        trailing_activated_long := true
        trailing_stop_long := strategy.position_avg_price * (1 + trailing_activation_pct / 100 - trailing_distance_pct / 100)
    
    if trailing_activated_long
        new_trailing = close * (1 - trailing_distance_pct / 100)
        if new_trailing > trailing_stop_long
            trailing_stop_long := new_trailing
else
    trailing_stop_long := na
    trailing_activated_long := false

// SHORT Trailing Stop
if strategy.position_size < 0
    if not trailing_activated_short and current_profit_short >= trailing_activation_pct
        trailing_activated_short := true
        trailing_stop_short := strategy.position_avg_price * (1 - trailing_activation_pct / 100 + trailing_distance_pct / 100)
    
    if trailing_activated_short
        new_trailing = close * (1 + trailing_distance_pct / 100)
        if new_trailing < trailing_stop_short
            trailing_stop_short := new_trailing
else
    trailing_stop_short := na
    trailing_activated_short := false

// =====================
// EXIT CONDITIONS
// =====================
long_tp = strategy.position_avg_price * (1 + tp_pct / 100)
long_sl = strategy.position_avg_price * (1 - sl_pct / 100)
long_trailing_hit = strategy.position_size > 0 and low <= trailing_stop_long and not na(trailing_stop_long)

short_tp = strategy.position_avg_price * (1 - tp_pct / 100)
short_sl = strategy.position_avg_price * (1 + sl_pct / 100)
short_trailing_hit = strategy.position_size < 0 and high >= trailing_stop_short and not na(trailing_stop_short)

// =====================
// ENTRY LOGIC
// =====================
if long_cond
    strategy.entry("LONG", strategy.long, comment="LONG")

if short_cond
    strategy.entry("SHORT", strategy.short, comment="SHORT")

// =====================
// EXIT LOGIC (Simple and Clean)
// =====================
// Trailing Stop (Priority 1)
if long_trailing_hit
    strategy.close("LONG", comment="Trailing Stop")

if short_trailing_hit
    strategy.close("SHORT", comment="Trailing Stop")

// TP/SL (Priority 2 - only if trailing not active)
if strategy.position_size > 0 and not trailing_activated_long
    strategy.exit("TP/SL LONG", "LONG", limit=long_tp, stop=long_sl, comment="TP/SL")

if strategy.position_size < 0 and not trailing_activated_short
    strategy.exit("TP/SL SHORT", "SHORT", limit=short_tp, stop=short_sl, comment="TP/SL")

// Update trailing stop (Priority 3 - when trailing is active)
if strategy.position_size > 0 and trailing_activated_long and not na(trailing_stop_long) and not long_trailing_hit
    strategy.exit("TRAILING LONG", "LONG", stop=trailing_stop_long, comment="Trailing")

if strategy.position_size < 0 and trailing_activated_short and not na(trailing_stop_short) and not short_trailing_hit
    strategy.exit("TRAILING SHORT", "SHORT", stop=trailing_stop_short, comment="Trailing")

// =====================
// VISUAL
// =====================
plot(strategy.position_size > 0 and not na(trailing_stop_long) ? trailing_stop_long : na, 
     "Trailing Stop", color=color.new(color.orange, 0), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 and not na(trailing_stop_short) ? trailing_stop_short : na, 
     "Trailing Stop", color=color.new(color.orange, 0), style=plot.style_linebr, linewidth=1)

bgcolor(long_cond ? color.new(color.green, 90) : na, title="Long Signal")
bgcolor(short_cond ? color.new(color.red, 90) : na, title="Short Signal")

