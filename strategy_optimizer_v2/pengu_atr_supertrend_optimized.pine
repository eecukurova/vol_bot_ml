//@version=5
strategy("PENGU ATR SuperTrend Optimized", shorttitle="PENGU ST", overlay=true, 
         default_qty_type=strategy.percent_of_equity, default_qty_value=10,
         initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.1)

// ============================================================================
// PENGU ATR SUPER TREND OPTIMIZED
// ============================================================================

// ATR Parameters - Optimized for PENGU
atr_period = input.int(14, "ATR Period", minval=10, maxval=20, group="ATR Settings")
atr_multiplier = input.float(2.5, "ATR Multiplier (Sensitivity)", minval=2.0, maxval=4.0, step=0.1, group="ATR Settings")
supertrend_multiplier = input.float(1.5, "SuperTrend Multiplier", minval=1.0, maxval=2.5, step=0.1, group="ATR Settings")

// Heikin Ashi Option
use_heikin_ashi = input.bool(true, "Use Heikin Ashi Candles", group="Filter Settings")

// Risk Management - Optimized for PENGU
stop_loss_pct = input.float(1.5, "Stop Loss (%)", minval=0.8, maxval=2.5, step=0.1, group="Risk Management") / 100
take_profit_pct = input.float(2.5, "Take Profit (%)", minval=1.5, maxval=4.0, step=0.1, group="Risk Management") / 100
trailing_stop = input.bool(true, "Enable Trailing Stop", group="Risk Management")
trailing_percent = input.float(0.8, "Trailing Stop (%)", minval=0.5, maxval=1.5, step=0.1, group="Risk Management") / 100

// Volume Filter
use_volume_filter = input.bool(true, "Use Volume Filter", group="Filter Settings")
volume_multiplier = input.float(1.5, "Volume Multiplier", minval=1.2, maxval=2.0, step=0.1, group="Filter Settings")

// RSI Filter
use_rsi_filter = input.bool(true, "Use RSI Filter", group="Filter Settings")
rsi_period = input.int(14, "RSI Period", minval=10, maxval=21, group="Filter Settings")
rsi_oversold = input.int(35, "RSI Oversold", minval=25, maxval=45, group="Filter Settings")
rsi_overbought = input.int(65, "RSI Overbought", minval=55, maxval=75, group="Filter Settings")

// Trend Filter (EMA Filter)
use_trend_filter = input.bool(true, "Use Trend Filter", group="Filter Settings")
trend_ema_period = input.int(50, "Trend EMA Period", minval=30, maxval=100, group="Filter Settings")

// Timeframe Filter (for trading hours)
use_timeframe_filter = input.bool(false, "Use Timeframe Filter", group="Filter Settings")
start_hour = input.int(8, "Start Hour (UTC)", minval=0, maxval=23, group="Filter Settings")
end_hour = input.int(22, "End Hour (UTC)", minval=0, maxval=23, group="Filter Settings")

// ============================================================================
// ATR SUPER TREND CALCULATIONS
// ============================================================================

// ATR calculation
xATR = ta.atr(atr_period)
nLoss = atr_multiplier * xATR

// Source (Heikin Ashi or Regular)
ha_close = (open + high + low + close) / 4
ha_open = na(ha_open[1]) ? (open + close) / 2 : (ha_open[1] + ha_close[1]) / 2
src = use_heikin_ashi ? ha_close : close

// ATR Trailing Stop calculation
var float xATRTrailingStop = na
if na(xATRTrailingStop[1])
    xATRTrailingStop := src - nLoss
else
    if src > xATRTrailingStop[1] and src[1] > xATRTrailingStop[1]
        xATRTrailingStop := math.max(xATRTrailingStop[1], src - nLoss)
    else if src < xATRTrailingStop[1] and src[1] < xATRTrailingStop[1]
        xATRTrailingStop := math.min(xATRTrailingStop[1], src + nLoss)
    else if src > xATRTrailingStop[1]
        xATRTrailingStop := src - nLoss
    else
        xATRTrailingStop := src + nLoss

// Position calculation
var int pos = 0
if src[1] < xATRTrailingStop[1] and src > xATRTrailingStop
    pos := 1
else if src[1] > xATRTrailingStop[1] and src < xATRTrailingStop
    pos := -1
else
    pos := pos[1]

// SuperTrend calculation
superTrend = xATR * supertrend_multiplier
trendUp = hl2 - superTrend
trendDown = hl2 + superTrend

var float superTrendLine = na
if na(superTrendLine[1])
    superTrendLine := trendDown
else
    if close > superTrendLine[1]
        superTrendLine := math.max(trendUp, superTrendLine[1])
    else
        superTrendLine := math.min(trendDown, superTrendLine[1])

// ============================================================================
// FILTERS
// ============================================================================

// Volume filter
volume_condition = not use_volume_filter or volume > ta.sma(volume, 20) * volume_multiplier

// Timeframe filter
timeframe_condition = not use_timeframe_filter or (hour >= start_hour and hour <= end_hour)

// RSI filter
rsi = ta.rsi(src, rsi_period)
rsi_condition_long = not use_rsi_filter or (rsi > rsi_oversold and rsi < rsi_overbought)
rsi_condition_short = not use_rsi_filter or (rsi > rsi_oversold and rsi < rsi_overbought)

// Trend filter (EMA)
trend_ema = ta.ema(src, trend_ema_period)
trend_condition_long = not use_trend_filter or src > trend_ema
trend_condition_short = not use_trend_filter or src < trend_ema

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// Crossover signals
buy_atr = ta.crossover(src, xATRTrailingStop)
sell_atr = ta.crossunder(src, xATRTrailingStop)

// SuperTrend signals
buy_supertrend = ta.crossover(close, superTrendLine)
sell_supertrend = ta.crossunder(close, superTrendLine)

// Combined signals with filters
long_signal = (buy_atr or buy_supertrend) and volume_condition and timeframe_condition and rsi_condition_long and trend_condition_long
short_signal = (sell_atr or sell_supertrend) and volume_condition and timeframe_condition and rsi_condition_short and trend_condition_short

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Entry conditions
if long_signal and strategy.position_size == 0
    strategy.entry("Long", strategy.long, comment="PENGU Long")

if short_signal and strategy.position_size == 0
    strategy.entry("Short", strategy.short, comment="PENGU Short")

// Exit conditions with risk management
if strategy.position_size > 0
    strategy.exit("Exit Long", from_entry="Long", 
                 stop=strategy.position_avg_price * (1 - stop_loss_pct), 
                 limit=strategy.position_avg_price * (1 + take_profit_pct),
                 comment="SL/TP")
    
    // Trailing stop for long
    if trailing_stop
        trail_price = strategy.position_avg_price * (1 + trailing_percent)
        strategy.exit("Trail Long", from_entry="Long", 
                     trail_price=trail_price, 
                     trail_offset=strategy.position_avg_price * trailing_percent,
                     comment="Trail")

if strategy.position_size < 0
    strategy.exit("Exit Short", from_entry="Short", 
                 stop=strategy.position_avg_price * (1 + stop_loss_pct), 
                 limit=strategy.position_avg_price * (1 - take_profit_pct),
                 comment="SL/TP")
    
    // Trailing stop for short
    if trailing_stop
        trail_price = strategy.position_avg_price * (1 - trailing_percent)
        strategy.exit("Trail Short", from_entry="Short", 
                     trail_price=trail_price, 
                     trail_offset=strategy.position_avg_price * trailing_percent,
                     comment="Trail")

// ============================================================================
// PLOTTING
// ============================================================================

// Plot SuperTrend line
plot(superTrendLine, color=color.blue, linewidth=2, title="SuperTrend")

// Plot ATR Trailing Stop
plot(xATRTrailingStop, color=color.red, linewidth=1, title="ATR Trailing Stop")

// Plot source (Heikin Ashi or Regular)
plot(ha_close, color=color.orange, linewidth=1, title="Heikin Ashi Close", display=use_heikin_ashi ? display.all : display.none)
plot(src, color=color.purple, linewidth=1, title="Source", display=use_heikin_ashi ? display.none : display.all)

// Plot signals
plotshape(long_signal, title="Long Signal", text="LONG", style=shape.labelup, 
          location=location.belowbar, color=color.green, textcolor=color.white, size=size.small)
plotshape(short_signal, title="Short Signal", text="SHORT", style=shape.labeldown, 
          location=location.abovebar, color=color.red, textcolor=color.white, size=size.small)

// Background color for trend
bgcolor(pos == 1 ? color.new(color.green, 95) : pos == -1 ? color.new(color.red, 95) : na, title="Trend Background")

// Plot ATR value
plot(close + xATR, color=color.gray, linewidth=1, title="ATR Upper", style=plot.style_linebr)
plot(close - xATR, color=color.gray, linewidth=1, title="ATR Lower", style=plot.style_linebr)

// ============================================================================
// INFORMATION TABLE
// ============================================================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 10, bgcolor=color.white, border_width=1)
    
    // Headers
    table.cell(info_table, 0, 0, "Parameter", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, text_size=size.small)
    
    // ATR Settings
    table.cell(info_table, 0, 1, "ATR Period", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 1, str.tostring(atr_period), text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 2, "ATR Multiplier", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 2, str.tostring(atr_multiplier), text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 3, "SuperTrend Mult", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 3, str.tostring(supertrend_multiplier), text_color=color.black, text_size=size.small)
    
    // Risk Management
    table.cell(info_table, 0, 4, "Stop Loss", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 4, str.tostring(stop_loss_pct * 100) + "%", text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 5, "Take Profit", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 5, str.tostring(take_profit_pct * 100) + "%", text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 6, "Trailing Stop", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 6, trailing_stop ? "ON" : "OFF", 
               text_color=trailing_stop ? color.green : color.red, text_size=size.small)
    
    // Filters
    table.cell(info_table, 0, 7, "Heikin Ashi", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 7, use_heikin_ashi ? "ON" : "OFF", 
               text_color=use_heikin_ashi ? color.green : color.red, text_size=size.small)
    
    table.cell(info_table, 0, 8, "Volume Filter", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 8, use_volume_filter ? "ON" : "OFF", 
               text_color=use_volume_filter ? color.green : color.red, text_size=size.small)
    
    table.cell(info_table, 0, 9, "Current Trend", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 9, pos == 1 ? "Bullish" : pos == -1 ? "Bearish" : "Neutral", 
               text_color=pos == 1 ? color.green : pos == -1 ? color.red : color.gray, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(long_signal, title="PENGU Long Alert", message="PENGU Long Signal - ATR SuperTrend")
alertcondition(short_signal, title="PENGU Short Alert", message="PENGU Short Signal - ATR SuperTrend")

// ============================================================================
// NOTES
// ============================================================================
// Bu strateji PENGU/USDT için optimize edilmiştir
// - ATR SuperTrend bazlı sinyal sistemi
// - Heikin Ashi filtreleme
// - RSI ve EMA trend filtreleri
// - Volume filtreleme
// - Trailing stop desteği
// - Risk yönetimi: Stop Loss 1.5%, Take Profit 2.5%
// - Optimize edilmiş parametreler
