//@version=5
strategy("PENGU Winner Strategy", shorttitle="PENGU Winner", overlay=true,
         initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.1)

// ============================================================================
// PENGU WINNER STRATEGY
// LLM Analysis Result: RSI + Volume is the best combination
// Test Results: +2.66% return, 69.2% win rate, 39 trades
// ============================================================================

// === Inputs ===
rsi_oversold = input.int(40, title="RSI Oversold Threshold", minval=20, maxval=50)
rsi_overbought = input.int(60, title="RSI Overbought Threshold", minval=50, maxval=80)
volume_threshold = input.float(1.5, title="Volume Threshold", minval=1.0, maxval=3.0, step=0.1)

tp_pct = input.float(1.0, title="Take Profit %", minval=0.5, maxval=5.0, step=0.1)
sl_pct = input.float(2.0, title="Stop Loss %", minval=1.0, maxval=5.0, step=0.1)

// === Indicators ===
rsi = ta.rsi(close, 14)
volume_ma = ta.sma(volume, 20)
volume_ratio = volume / volume_ma

// === Signals ===
buy_signal = (rsi < rsi_oversold) and (volume_ratio > volume_threshold)
sell_signal = (rsi > rsi_overbought) and (volume_ratio > volume_threshold)

// === Strategy ===
var float entry_price = na
var bool is_long = false

// Entry - Long
if buy_signal and strategy.position_size == 0
    entry_price := close
    is_long := true
    strategy.entry("Long", strategy.long, comment="Buy")

// Entry - Short
if sell_signal and strategy.position_size == 0
    entry_price := close
    is_long := false
    strategy.entry("Short", strategy.short, comment="Sell")

// Exit with TP/SL
if strategy.position_size != 0 and not na(entry_price)
    // Long position
    if is_long
        current_return = ((close - entry_price) / entry_price) * 100
        
        // TP
        if current_return >= tp_pct
            strategy.close("Long", comment="TP")
            entry_price := na
        // SL
        else if current_return <= -sl_pct
            strategy.close("Long", comment="SL")
            entry_price := na
    
    // Short position
    else
        current_return = ((entry_price - close) / entry_price) * 100
        
        // TP
        if current_return >= tp_pct
            strategy.close("Short", comment="TP")
            entry_price := na
        // SL
        else if current_return <= -sl_pct
            strategy.close("Short", comment="SL")
            entry_price := na

// Opposite signal exit
if sell_signal and strategy.position_size > 0
    strategy.close("Long", comment="Exit")
    entry_price := na

if buy_signal and strategy.position_size < 0
    strategy.close("Short", comment="Exit")
    entry_price := na

// === Plotting ===
// Signal markers
plotshape(buy_signal and strategy.position_size == 0, title="Buy Signal", location=location.belowbar,
          color=color.new(color.lime, 0), style=shape.triangleup, size=size.large, text="BUY")
plotshape(sell_signal and strategy.position_size == 0, title="Short Signal", location=location.abovebar,
          color=color.new(color.orange, 0), style=shape.triangledown, size=size.large, text="SHORT")
plotshape(sell_signal and strategy.position_size > 0, title="Close Long", location=location.abovebar,
          color=color.new(color.red, 0), style=shape.triangledown, size=size.normal, text="CLOSE")
plotshape(buy_signal and strategy.position_size < 0, title="Close Short", location=location.belowbar,
          color=color.new(color.yellow, 0), style=shape.triangleup, size=size.normal, text="CLOSE")

// Background coloring for RSI zones
bgcolor(rsi < rsi_oversold ? color.new(color.green, 95) : na, title="Oversold Zone")
bgcolor(rsi > rsi_overbought ? color.new(color.red, 95) : na, title="Overbought Zone")

// Current position indicator
bgcolor(strategy.position_size > 0 ? color.new(color.blue, 95) : na, title="In Position")

// RSI with levels
hline(rsi_oversold, "Oversold", color=color.green, linestyle=hline.style_dashed, linewidth=1)
hline(50, "RSI Mid", color=color.gray, linestyle=hline.style_dotted, linewidth=1)
hline(rsi_overbought, "Overbought", color=color.red, linestyle=hline.style_dashed, linewidth=1)

// Information table
if barstate.islast
    var table info = table.new(position.top_right, 2, 5, bgcolor=color.white, border_width=1)
    table.cell(info, 0, 0, "Strategy", bgcolor=color.gray, text_color=color.white)
    table.cell(info, 1, 0, "PENGU Winner", bgcolor=color.gray, text_color=color.white)
    table.cell(info, 0, 1, "RSI", text_color=color.black)
    table.cell(info, 1, 1, str.tostring(math.round(rsi)) + " (" + (rsi < rsi_oversold ? "OS" : rsi > rsi_overbought ? "OB" : "N") + ")", 
               text_color=rsi < rsi_oversold ? color.green : rsi > rsi_overbought ? color.red : color.black)
    table.cell(info, 0, 2, "Volume Ratio", text_color=color.black)
    table.cell(info, 1, 2, str.tostring(volume_ratio, "#.##"), text_color=color.black)
    table.cell(info, 0, 3, "Position", text_color=color.black)
    table.cell(info, 1, 3, strategy.position_size > 0 ? "Long" : strategy.position_size < 0 ? "Short" : "No Position",
               text_color=strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.orange : color.gray)
    table.cell(info, 0, 4, "Entry Price", text_color=color.black)
    table.cell(info, 1, 4, strategy.position_size > 0 ? str.tostring(strategy.position_avg_price, "#.####") : "N/A",
               text_color=color.black)

