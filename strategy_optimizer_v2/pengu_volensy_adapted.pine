//@version=5
strategy("PENGU Volensy Adapted", overlay=true,
    initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.1,
    pyramiding=0, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================================================
// PENGU VOLENSY ADAPTED
// Original Volensy adapted for PENGU (lower thresholds)
// ============================================================================

// === Parameters (ADAPTED FOR PENGU) ===
useDaily   = input.bool(true, "Use Daily Conditions")
chgPctMin  = input.float(2.0, "Min Close Change %", step=0.1)  // Reduced from 4% to 2%
volKatsayi = input.float(1.2, "Volume Multiplier", step=0.1)    // Reduced from 1.4 to 1.2
lenVolMa   = input.int(10, "Volume MA Period")
lenBreak   = input.int(50, "Breakout Period", minval=2)          // Reduced from 250 to 50
absVolMin  = input.float(50000, "Min Absolute Volume")          // Reduced from 100,000

tpPct      = input.float(3.0, "Take Profit %", minval=0.1, step=0.1)
slPct      = input.float(2.0, "Stop Loss %", minval=0.1, step=0.1)
timeStop   = input.int(5, "Time Stop (bars)", minval=0)

confirmBar = input.bool(true, "Confirm on bar close")

// === Multi-timeframe ===
tfDaily = "D"

// Daily data
cD     = request.security(syminfo.tickerid, tfDaily, close, lookahead=barmerge.lookahead_off)
cD1    = request.security(syminfo.tickerid, tfDaily, close[1], lookahead=barmerge.lookahead_off)
vD     = request.security(syminfo.tickerid, tfDaily, volume, lookahead=barmerge.lookahead_off)
vmaD   = request.security(syminfo.tickerid, tfDaily, ta.sma(volume, lenVolMa), lookahead=barmerge.lookahead_off)
hiPrevD = request.security(syminfo.tickerid, tfDaily, ta.highest(close[1], lenBreak), lookahead=barmerge.lookahead_off)

// Current timeframe
c      = close
c1     = close[1]
v      = volume
vma    = ta.sma(volume, lenVolMa)
hiPrev = ta.highest(close[1], lenBreak)

// Choose series
priceNow    = useDaily ? cD      : c
pricePrev   = useDaily ? cD1      : c1
volNow      = useDaily ? vD       : v
volMaNow    = useDaily ? vmaD     : vma
highestPrev = useDaily ? hiPrevD : hiPrev

// === Conditions ===
pctChange  = (priceNow / pricePrev - 1.0) * 100.0
condPrice  = pctChange > chgPctMin
condVolMa  = volNow > volMaNow * volKatsayi
condBreak  = priceNow > highestPrev
condAbsVol = volNow > absVolMin

rawLong = condPrice and condVolMa and condBreak and condAbsVol
longSignal = confirmBar ? (rawLong and barstate.isconfirmed) : rawLong

// === Entry ===
if (longSignal and strategy.position_size == 0)
    strategy.entry("LONG", strategy.long)

// === TP/SL ===
longAvg = strategy.position_avg_price
tpPrice = longAvg * (1 + tpPct/100.0)
slPrice = longAvg * (1 - slPct/100.0)

if (strategy.position_size > 0)
    strategy.exit("TP/SL", from_entry="LONG", limit=tpPrice, stop=slPrice)

// === Time Stop ===
var int barsInPos = 0
if strategy.position_size > 0
    newEntry = nz(strategy.position_size[1], 0) == 0 and strategy.position_size > 0
    barsInPos := newEntry ? 1 : (barsInPos + 1)
else
    barsInPos := 0

useTimeStop = timeStop > 0 and strategy.position_size > 0 and barsInPos >= timeStop
if useTimeStop
    strategy.close("LONG", comment="TimeStop")

// === Plotting ===
plotshape(longSignal, title="BUY Signal", style=shape.triangleup, 
          color=color.new(color.lime, 0), location=location.belowbar, 
          size=size.large, text="BUY")
plot(highestPrev, "Breakout Line", color=color.new(color.orange, 50), linewidth=2)

bgcolor(longSignal ? color.new(color.green, 90) : na)

