//@version=5
strategy(title="Simple ATR SuperTrend Test", shorttitle="ATR-ST-Test", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================================================
// SIMPLE PARAMETERS - TEST VERSION
// ============================================================================

// ATR Parameters - Simple
key_value = input.float(2.0, title="Key Value", minval=1.0, maxval=5.0, step=0.1, group="ATR Settings")
atr_period = input.int(10, title="ATR Period", minval=5, maxval=50, step=1, group="ATR Settings")

// SuperTrend Parameters - Simple
multiplier = input.float(1.5, title="SuperTrend Multiplier", minval=1.0, maxval=3.0, step=0.1, group="SuperTrend Settings")

// Display Options
show_signals = input.bool(true, title="Show Buy/Sell Signals", group="Display")
show_supertrend = input.bool(true, title="Show SuperTrend Line", group="Display")

// ============================================================================
// SIMPLE CALCULATIONS
// ============================================================================

// ATR Calculation
xATR = ta.atr(atr_period)
nLoss = key_value * xATR

// ATR Trailing Stop Calculation
var float xATRTrailingStop = na
xATRTrailingStop := na(xATRTrailingStop[1]) ? close - nLoss : 
   close > xATRTrailingStop[1] and close[1] > xATRTrailingStop[1] ? math.max(xATRTrailingStop[1], close - nLoss) :
   close < xATRTrailingStop[1] and close[1] < xATRTrailingStop[1] ? math.min(xATRTrailingStop[1], close + nLoss) :
   close > xATRTrailingStop[1] ? close - nLoss : close + nLoss

// Position Calculation
var int pos = 0
pos := close[1] < xATRTrailingStop[1] and close > xATRTrailingStop[1] ? 1 :
   close[1] > xATRTrailingStop[1] and close < xATRTrailingStop[1] ? -1 : pos[1]

// EMA(1) for signal confirmation
ema1 = ta.ema(close, 1)

// SIMPLE Signal Detection - Only ATR
above = ta.crossover(ema1, xATRTrailingStop)
below = ta.crossover(xATRTrailingStop, ema1)

buy_signal = close > xATRTrailingStop and above
sell_signal = close < xATRTrailingStop and below

// SuperTrend Calculation
hl2 = (high + low) / 2
superTrend = xATR * multiplier
trendUp = hl2 - superTrend
trendDown = hl2 + superTrend

var float superTrendLine = na
superTrendLine := na(superTrendLine[1]) ? na : 
   close > superTrendLine[1] ? math.max(trendUp, superTrendLine[1]) : math.min(trendDown, superTrendLine[1])
superTrendLine := na(superTrendLine) ? na : 
   close > superTrendLine ? trendDown : trendUp

// SuperTrend Signals
buy_supertrend = ta.crossover(close, superTrendLine)
sell_supertrend = ta.crossunder(close, superTrendLine)

// ============================================================================
// STRATEGY EXECUTION - SIMPLE VERSION
// ============================================================================

// Entry Conditions - Only ATR signals first
if buy_signal and strategy.position_size == 0
    strategy.entry("Long", strategy.long, comment="ATR Buy")

if sell_signal and strategy.position_size == 0
    strategy.entry("Short", strategy.short, comment="ATR Sell")

// ============================================================================
// PLOTTING
// ============================================================================

// Color coding
xcolor = pos == -1 ? color.red : pos == 1 ? color.green : color.blue

// ATR Trailing Stop Line
plot(xATRTrailingStop, color=xcolor, linewidth=2, title="ATR Trailing Stop")

// SuperTrend Line
plot(show_supertrend ? superTrendLine : na, color=color.blue, linewidth=2, title="SuperTrend Line")

// Buy/Sell Signals - ATR Only
plotshape(show_signals and buy_signal, title="ATR Buy Signal", text="BUY", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, size=size.small)
plotshape(show_signals and sell_signal, title="ATR Sell Signal", text="SELL", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, size=size.small)

// SuperTrend Signals
plotshape(show_signals and buy_supertrend, title="SuperTrend Buy", text="ST+", style=shape.labelup, location=location.belowbar, color=color.lime, textcolor=color.black, size=size.tiny)
plotshape(show_signals and sell_supertrend, title="SuperTrend Sell", text="ST-", style=shape.labeldown, location=location.abovebar, color=color.orange, textcolor=color.black, size=size.tiny)

// Bar Coloring
barcolor(pos == 1 ? color.new(color.green, 80) : pos == -1 ? color.new(color.red, 80) : na, title="Bar Color")

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(buy_signal, title="ATR Buy Signal", message="ATR Buy Signal: {{ticker}}")
alertcondition(sell_signal, title="ATR Sell Signal", message="ATR Sell Signal: {{ticker}}")
alertcondition(buy_supertrend, title="SuperTrend Buy", message="SuperTrend Buy Signal: {{ticker}}")
alertcondition(sell_supertrend, title="SuperTrend Sell", message="SuperTrend Sell Signal: {{ticker}}")

// ============================================================================
// SIMPLE PERFORMANCE TABLE
// ============================================================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 6, bgcolor=color.white, border_width=1)
    
    net_profit = strategy.netprofit
    total_trades = strategy.closedtrades
    win_rate = total_trades > 0 ? strategy.wintrades / total_trades * 100 : 0
    
    table.cell(info_table, 0, 0, "Test Metrics", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, bgcolor=color.gray)
    
    table.cell(info_table, 0, 1, "Net Profit", text_color=color.black)
    table.cell(info_table, 1, 1, str.tostring(net_profit, "#.##"), text_color=color.black)
    
    table.cell(info_table, 0, 2, "Total Trades", text_color=color.black)
    table.cell(info_table, 1, 2, str.tostring(total_trades), text_color=color.black)
    
    table.cell(info_table, 0, 3, "Win Rate %", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(win_rate, "#.##"), text_color=color.black)
    
    table.cell(info_table, 0, 4, "Key Value", text_color=color.black)
    table.cell(info_table, 1, 4, str.tostring(key_value), text_color=color.black)
    
    table.cell(info_table, 0, 5, "ATR Period", text_color=color.black)
    table.cell(info_table, 1, 5, str.tostring(atr_period), text_color=color.black)

// ============================================================================
// NOTES
// ============================================================================

// Bu basit test versiyonu:
// 1. Sadece ATR sinyalleri kullanır (SuperTrend değil)
// 2. Basit parametreler: key_value=2.0, atr_period=10, multiplier=1.5
// 3. Gerçek sinyal üretip üretmediğini test eder
// 4. AAPL'de son 1 yılda kaç sinyal ürettiğini gösterir
// 5. Çalışırsa, sonra optimize ederiz
