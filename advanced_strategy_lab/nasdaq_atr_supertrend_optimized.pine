//@version=5
strategy("NASDAQ ATR SuperTrend Optimized", shorttitle="NASDAQ ATR ST", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ============================================================================
// OPTIMIZE EDİLMİŞ PARAMETRELER (Python testlerinden)
// ============================================================================
a = input.float(0.5, "ATR Sensitivity", minval=0.1, maxval=5.0, step=0.1, group="Optimized Parameters")
c = input.int(2, "ATR Period", minval=1, maxval=20, group="Optimized Parameters")
st_factor = input.float(0.4, "SuperTrend Factor", minval=0.1, maxval=3.0, step=0.1, group="Optimized Parameters")

// NASDAQ-specific settings
use_ema_confirmation = input.bool(false, "Use EMA Confirmation", group="NASDAQ Features")
ema_fast_len = input.int(9, "EMA Fast Length", minval=1, maxval=50, group="NASDAQ Features")
ema_slow_len = input.int(21, "EMA Slow Length", minval=1, maxval=100, group="NASDAQ Features")
use_heikin_ashi = input.bool(false, "Use Heikin Ashi", group="NASDAQ Features")
volume_filter = input.bool(false, "Use Volume Filter", group="NASDAQ Features")
min_volume_mult = input.float(1.5, "Min Volume Multiplier", minval=0.5, maxval=5.0, step=0.1, group="NASDAQ Features")

// Risk Management
stop_loss_pct = input.float(5.0, "Stop Loss %", minval=1.0, maxval=20.0, step=0.5, group="Risk Management")
take_profit_pct = input.float(15.0, "Take Profit %", minval=5.0, maxval=50.0, step=1.0, group="Risk Management")

// ============================================================================
// ATR SUPER TREND CALCULATION
// ============================================================================
atr_value = ta.atr(c)
hl2_value = hl2

// ATR Trailing Stop
atr_trailing_stop = hl2_value - (a * atr_value)

// SuperTrend
super_trend = hl2_value + (st_factor * atr_value)

// ============================================================================
// HEIKIN ASHI CALCULATION (NASDAQ-specific)
// ============================================================================
ha_close = (open + high + low + close) / 4
ha_open = na(ha_open[1]) ? open : (ha_open[1] + ha_close[1]) / 2
ha_high = math.max(high, math.max(ha_open, ha_close))
ha_low = math.min(low, math.min(ha_open, ha_close))

// Use HA or regular candles
signal_close = use_heikin_ashi ? ha_close : close
signal_open = use_heikin_ashi ? ha_open : open
signal_high = use_heikin_ashi ? ha_high : high
signal_low = use_heikin_ashi ? ha_low : low

// ============================================================================
// EMA CONFIRMATION (NASDAQ-specific)
// ============================================================================
ema_fast = ta.ema(signal_close, ema_fast_len)
ema_slow = ta.ema(signal_close, ema_slow_len)

// ============================================================================
// VOLUME FILTER (NASDAQ-specific)
// ============================================================================
volume_sma = ta.sma(volume, 20)
volume_ratio = volume / volume_sma
volume_confirm = volume_filter ? volume_ratio > min_volume_mult : true

// ============================================================================
// SIGNAL GENERATION
// ============================================================================
// Base ATR SuperTrend signals
atr_st_buy_signal = signal_close > super_trend and signal_close[1] <= super_trend[1]
atr_st_sell_signal = signal_close < super_trend and signal_close[1] >= super_trend[1]

// Heikin Ashi confirmation
ha_buy_signal = use_heikin_ashi ? (ha_close > ha_open and ha_close[1] <= ha_open[1]) : true
ha_sell_signal = use_heikin_ashi ? (ha_close < ha_open and ha_close[1] >= ha_open[1]) : true

// EMA confirmation
ema_buy_signal = use_ema_confirmation ? (ema_fast > ema_slow and ema_fast[1] <= ema_slow[1]) : true
ema_sell_signal = use_ema_confirmation ? (ema_fast < ema_slow and ema_fast[1] >= ema_slow[1]) : true

// Final signals
buy_signal = atr_st_buy_signal and ha_buy_signal and ema_buy_signal and volume_confirm
sell_signal = atr_st_sell_signal and ha_sell_signal and ema_sell_signal and volume_confirm

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================
if buy_signal and strategy.position_size == 0
    stop_loss_price = close * (1 - stop_loss_pct / 100)
    take_profit_price = close * (1 + take_profit_pct / 100)
    
    strategy.entry("BUY", strategy.long)
    strategy.exit("BUY Exit", "BUY", stop=stop_loss_price, limit=take_profit_price)

if sell_signal and strategy.position_size == 0
    stop_loss_price = close * (1 + stop_loss_pct / 100)
    take_profit_price = close * (1 - take_profit_pct / 100)
    
    strategy.entry("SELL", strategy.short)
    strategy.exit("SELL Exit", "SELL", stop=stop_loss_price, limit=take_profit_price)

// ============================================================================
// PLOTTING
// ============================================================================
// SuperTrend line
plot(super_trend, "SuperTrend", color=signal_close > super_trend ? color.green : color.red, linewidth=2)

// ATR Trailing Stop
plot(atr_trailing_stop, "ATR Trailing Stop", color=color.blue, linewidth=1)

// EMA lines (if enabled)
plot(use_ema_confirmation ? ema_fast : na, "EMA Fast", color=color.yellow, linewidth=1)
plot(use_ema_confirmation ? ema_slow : na, "EMA Slow", color=color.orange, linewidth=1)

// Heikin Ashi candles (if enabled)
plotcandle(use_heikin_ashi ? ha_open : na, use_heikin_ashi ? ha_high : na, use_heikin_ashi ? ha_low : na, use_heikin_ashi ? ha_close : na, "Heikin Ashi", color=ha_close > ha_open ? color.green : color.red)

// Signal markers
plotshape(buy_signal, "Buy Signal", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(sell_signal, "Sell Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// ============================================================================
// INFORMATION TABLE
// ============================================================================
if barstate.islast
    var table info_table = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)
    
    table.cell(info_table, 0, 0, "Parameter", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 1, "ATR Sensitivity", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 1, str.tostring(a), text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 2, "ATR Period", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 2, str.tostring(c), text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 3, "SuperTrend Factor", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 3, str.tostring(st_factor), text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 4, "EMA Confirmation", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 4, use_ema_confirmation ? "ON" : "OFF", text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 5, "Heikin Ashi", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 5, use_heikin_ashi ? "ON" : "OFF", text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 6, "Volume Filter", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 6, volume_filter ? "ON" : "OFF", text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 7, "Stop Loss %", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 7, str.tostring(stop_loss_pct), text_color=color.black, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(buy_signal, "NASDAQ Buy Signal", "NASDAQ ATR SuperTrend: BUY signal detected")
alertcondition(sell_signal, "NASDAQ Sell Signal", "NASDAQ ATR SuperTrend: SELL signal detected")
