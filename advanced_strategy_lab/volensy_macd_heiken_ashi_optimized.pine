//@version=6
indicator(title="Volensy MACD Trend - Heiken Ashi Optimized", shorttitle="Volensy MACD HA", overlay=true)

// =========================
// 1) Optimized Parameters (Best Performance: SOL/USDT 4h)
// =========================
group_trend = "Trend / EMA"
emaLen      = input.int(20,  "Trend EMA Periyodu", minval=1, group=group_trend)

group_macd  = "MACD"
macdFast    = input.int(12,  "MACD HÄ±zlÄ± EMA", minval=1, group=group_macd)
macdSlow    = input.int(26,  "MACD YavaÅŸ EMA", minval=1, group=group_macd)
macdSignal  = input.int(9,   "MACD Sinyal EMA", minval=1, group=group_macd)

group_rsi   = "RSI"
rsiLen      = input.int(14,  "RSI Periyodu", minval=1, group=group_rsi)
rsiOB       = input.float(70,"RSI AÅŸÄ±rÄ± AlÄ±m", step=0.1, group=group_rsi)
rsiOS       = input.float(30,"RSI AÅŸÄ±rÄ± SatÄ±m", step=0.1, group=group_rsi)

group_atr   = "ATR & Risk Management"
atrLen      = input.int(14,  "ATR Periyodu", minval=1, group=group_atr)
slPercent   = input.float(1.5, "Stop Loss %", step=0.1, minval=0.1, maxval=10.0, group=group_atr)
tpPercent   = input.float(3.0, "Take Profit %", step=0.1, minval=0.1, maxval=20.0, group=group_atr)

group_viz   = "GÃ¶rsel / Alarm"
showBg      = input.bool(true,  "Trend BÃ¶lgesi Arka PlanÄ±nÄ± GÃ¶ster", group=group_viz)
showShapes  = input.bool(true,  "Grafikte AL/SAT ÃœÃ§genlerini GÃ¶ster", group=group_viz)
showLabels  = input.bool(true,  "AL/SAT Etiketlerini GÃ¶ster", group=group_viz)
showTP_SL   = input.bool(true,  "TP/SL Seviyelerini GÃ¶ster", group=group_viz)
onlyOnClose = input.bool(true,  "Sinyalleri Sadece Bar KapanÄ±ÅŸÄ±nda Ãœret", group=group_viz)

// =========================
// 2) Heiken Ashi HesaplamalarÄ±
// =========================
// Heiken Ashi Close
haClose = (open + high + low + close) / 4
// Heiken Ashi Open
var float haOpen = na
haOpen := na(haOpen[1]) ? (open + close) / 2 : (haOpen[1] + haClose[1]) / 2
// Heiken Ashi High
haHigh = math.max(high, math.max(haOpen, haClose))
// Heiken Ashi Low
haLow = math.min(low, math.min(haOpen, haClose))

// =========================
// 3) Ana Hesaplamalar (Heiken Ashi ile)
// =========================
emaTrend = ta.ema(haClose, emaLen)

// MACD (Heiken Ashi Close ile)
macd     = ta.ema(haClose, macdFast) - ta.ema(haClose, macdSlow)
macdSig  = ta.ema(macd, macdSignal)
macdHist = macd - macdSig

// RSI (Heiken Ashi Close ile)
rsi = ta.rsi(haClose, rsiLen)

// ATR
atr = ta.atr(atrLen)

// =========================
// 4) BileÅŸen KoÅŸullarÄ± ve Skorlar
// =========================
isBullTrend    = haClose > emaTrend
isBearTrend    = haClose < emaTrend
isBullMomentum = rsi > 50
isBearMomentum = rsi < 50
isBullPower    = macd > macdSig
isBearPower    = macd < macdSig

notOverbought = rsi < rsiOB
notOversold   = rsi > rsiOS

bullScore = (isBullTrend ? 1 : 0) + (isBullMomentum ? 1 : 0) + (isBullPower ? 1 : 0)
bearScore = (isBearTrend ? 1 : 0) + (isBearMomentum ? 1 : 0) + (isBearPower ? 1 : 0)

rawBuy  = (bullScore == 3) and notOverbought
rawSell = (bearScore == 3) and notOversold

canSignal = onlyOnClose ? barstate.isconfirmed : true

// =========================
// 5) Yinelenen AynÄ± Sinyali Engelleme
// =========================
var int lastDir = 0
buyOK  = canSignal and rawBuy  and (lastDir != 1)
sellOK = canSignal and rawSell and (lastDir != -1)

if buyOK
    lastDir := 1
else if sellOK
    lastDir := -1

// =========================
// 6) TP/SL HesaplamalarÄ±
// =========================
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na

if buyOK
    entryPrice := close
    stopLoss := entryPrice * (1 - slPercent / 100)
    takeProfit := entryPrice * (1 + tpPercent / 100)
else if sellOK
    entryPrice := close
    stopLoss := entryPrice * (1 + slPercent / 100)
    takeProfit := entryPrice * (1 - tpPercent / 100)

// =========================
// 7) GÃ¶rselleÅŸtirme
// =========================
// EMA Ã§izimi
plot(emaTrend, title="Trend EMA", color=color.new(color.blue, 0), linewidth=2)

// Arka plan
bgcolor(showBg ? (isBullTrend ? color.new(color.green, 89) : isBearTrend ? color.new(color.red, 89) : na) : na)

// ÃœÃ§gen ÅŸekiller
plotshape(showShapes and buyOK,  title="AL Sinyali ðŸ“ˆ",  style=shape.triangleup,   location=location.belowbar, size=size.small, color=color.new(color.lime, 0), text="AL ðŸ“ˆ")
plotshape(showShapes and sellOK, title="SAT Sinyali ðŸ“‰", style=shape.triangledown, location=location.abovebar,  size=size.small, color=color.new(color.red,  0), text="SAT ðŸ“‰")

// Etiketler
if showLabels and buyOK
    label.new(bar_index, low,  "AL ðŸ“ˆ",  style=label.style_label_up,   color=color.new(color.lime, 0), textcolor=color.black)
if showLabels and sellOK
    label.new(bar_index, high, "SAT ðŸ“‰", style=label.style_label_down, color=color.new(color.red,  0), textcolor=color.white)

// TP/SL Seviyeleri
if showTP_SL and not na(entryPrice)
    if lastDir == 1  // Long position
        line.new(bar_index, stopLoss, bar_index + 10, stopLoss, color=color.red, width=2, style=line.style_dashed)
        line.new(bar_index, takeProfit, bar_index + 10, takeProfit, color=color.green, width=2, style=line.style_dashed)
        label.new(bar_index, stopLoss, "SL: " + str.tostring(stopLoss, "#.##"), style=label.style_label_left, color=color.red, textcolor=color.white)
        label.new(bar_index, takeProfit, "TP: " + str.tostring(takeProfit, "#.##"), style=label.style_label_left, color=color.green, textcolor=color.white)
    else if lastDir == -1  // Short position
        line.new(bar_index, stopLoss, bar_index + 10, stopLoss, color=color.red, width=2, style=line.style_dashed)
        line.new(bar_index, takeProfit, bar_index + 10, takeProfit, color=color.green, width=2, style=line.style_dashed)
        label.new(bar_index, stopLoss, "SL: " + str.tostring(stopLoss, "#.##"), style=label.style_label_left, color=color.red, textcolor=color.white)
        label.new(bar_index, takeProfit, "TP: " + str.tostring(takeProfit, "#.##"), style=label.style_label_left, color=color.green, textcolor=color.white)

// Bar renklendirme
barcolor(isBullTrend ? color.new(color.green, 80) : isBearTrend ? color.new(color.red, 80) : na)

// =========================
// 8) Alarm KoÅŸullarÄ±
// =========================
alertcondition(buyOK,  title="AL Sinyali ðŸ“ˆ",  message="Volensy MACD HA: AL ðŸ“ˆ - EMA/RSI/MACD hepsi BULLISH. SL: " + str.tostring(stopLoss, "#.##") + " TP: " + str.tostring(takeProfit, "#.##"))
alertcondition(sellOK, title="SAT Sinyali ðŸ“‰", message="Volensy MACD HA: SAT ðŸ“‰ - EMA/RSI/MACD hepsi BEARISH. SL: " + str.tostring(stopLoss, "#.##") + " TP: " + str.tostring(takeProfit, "#.##"))

// =========================
// 9) Bilgi Paneli
// =========================
var table info = table.new(position.top_right, 1, 8, frame_color=color.new(color.black, 0), frame_width=1, border_width=0)
if barstate.islast
    table.cell(info, 0, 0, "Volensy MACD HA Optimized", text_color=color.white, bgcolor=color.new(color.blue, 75))
    table.cell(info, 0, 1, "EMA("+str.tostring(emaLen)+") = " + str.tostring(emaTrend, format.mintick), text_color=color.white, bgcolor=color.new(color.blue, 75))
    table.cell(info, 0, 2, "RSI("+str.tostring(rsiLen)+") = " + str.tostring(rsi, format.mintick), text_color=color.white)
    table.cell(info, 0, 3, "MACD = " + str.tostring(macd, format.mintick), text_color=color.white)
    table.cell(info, 0, 4, "Signal = " + str.tostring(macdSig, format.mintick), text_color=color.white)
    table.cell(info, 0, 5, "BullScore: " + str.tostring(bullScore) + " | BearScore: " + str.tostring(bearScore), text_color=color.white)
    table.cell(info, 0, 6, "ATR("+str.tostring(atrLen)+") = " + str.tostring(atr, format.mintick), text_color=color.white)
    table.cell(info, 0, 7, "SL: " + str.tostring(slPercent, "#.#") + "% | TP: " + str.tostring(tpPercent, "#.#") + "%", text_color=color.white)

// =========================
// 10) Performans Bilgileri
// =========================
var table perf = table.new(position.top_left, 1, 6, frame_color=color.new(color.black, 0), frame_width=1, border_width=0)
if barstate.islast
    table.cell(perf, 0, 0, "SOL/USDT 4h Results", text_color=color.white, bgcolor=color.new(color.green, 75))
    table.cell(perf, 0, 1, "PF: 4.50 | Return: 2.48%", text_color=color.white)
    table.cell(perf, 0, 2, "Max DD: -2.71%", text_color=color.white)
    table.cell(perf, 0, 3, "Win Rate: 91.30%", text_color=color.white)
    table.cell(perf, 0, 4, "Trades: 23", text_color=color.white)
    table.cell(perf, 0, 5, "Risk/Reward: 1:2", text_color=color.white)
