//@version=5
strategy(title="Ultra Simple ATR Test", shorttitle="ATR-Test", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================================================
// ULTRA SIMPLE PARAMETERS
// ============================================================================

key_value = input.float(2.0, title="Key Value", minval=1.0, maxval=5.0, step=0.1)
atr_period = input.int(10, title="ATR Period", minval=5, maxval=50, step=1)

// ============================================================================
// ULTRA SIMPLE CALCULATIONS
// ============================================================================

// ATR Calculation
xATR = ta.atr(atr_period)
nLoss = key_value * xATR

// ATR Trailing Stop Calculation
var float xATRTrailingStop = na
xATRTrailingStop := na(xATRTrailingStop[1]) ? close - nLoss : 
   close > xATRTrailingStop[1] and close[1] > xATRTrailingStop[1] ? math.max(xATRTrailingStop[1], close - nLoss) :
   close < xATRTrailingStop[1] and close[1] < xATRTrailingStop[1] ? math.min(xATRTrailingStop[1], close + nLoss) :
   close > xATRTrailingStop[1] ? close - nLoss : close + nLoss

// Position Calculation
var int pos = 0
pos := close[1] < xATRTrailingStop[1] and close > xATRTrailingStop[1] ? 1 :
   close[1] > xATRTrailingStop[1] and close < xATRTrailingStop[1] ? -1 : pos[1]

// EMA(1) for signal confirmation
ema1 = ta.ema(close, 1)

// SIMPLE Signal Detection
above = ta.crossover(ema1, xATRTrailingStop)
below = ta.crossover(xATRTrailingStop, ema1)

buy_signal = close > xATRTrailingStop and above
sell_signal = close < xATRTrailingStop and below

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

if buy_signal and strategy.position_size == 0
    strategy.entry("Long", strategy.long, comment="Buy")

if sell_signal and strategy.position_size == 0
    strategy.entry("Short", strategy.short, comment="Sell")

// ============================================================================
// PLOTTING
// ============================================================================

// Color coding
xcolor = pos == -1 ? color.red : pos == 1 ? color.green : color.blue

// ATR Trailing Stop Line
plot(xATRTrailingStop, color=xcolor, linewidth=2, title="ATR Trailing Stop")

// Buy/Sell Signals
plotshape(buy_signal, title="Buy Signal", text="BUY", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, size=size.small)
plotshape(sell_signal, title="Sell Signal", text="SELL", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, size=size.small)

// Bar Coloring
barcolor(pos == 1 ? color.new(color.green, 80) : pos == -1 ? color.new(color.red, 80) : na, title="Bar Color")

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(buy_signal, title="Buy Signal", message="Buy Signal: {{ticker}}")
alertcondition(sell_signal, title="Sell Signal", message="Sell Signal: {{ticker}}")

// ============================================================================
// PERFORMANCE TABLE
// ============================================================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 5, bgcolor=color.white, border_width=1)
    
    net_profit = strategy.netprofit
    total_trades = strategy.closedtrades
    win_rate = total_trades > 0 ? strategy.wintrades / total_trades * 100 : 0
    
    table.cell(info_table, 0, 0, "Ultra Simple Test", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, bgcolor=color.gray)
    
    table.cell(info_table, 0, 1, "Net Profit", text_color=color.black)
    table.cell(info_table, 1, 1, str.tostring(net_profit, "#.##"), text_color=color.black)
    
    table.cell(info_table, 0, 2, "Total Trades", text_color=color.black)
    table.cell(info_table, 1, 2, str.tostring(total_trades), text_color=color.black)
    
    table.cell(info_table, 0, 3, "Win Rate %", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(win_rate, "#.##"), text_color=color.black)
    
    table.cell(info_table, 0, 4, "Key Value", text_color=color.black)
    table.cell(info_table, 1, 4, str.tostring(key_value), text_color=color.black)

// ============================================================================
// NOTES
// ============================================================================

// Bu ultra basit versiyon:
// 1. Sadece ATR Trailing Stop kullanır
// 2. SuperTrend yok
// 3. Heikin Ashi yok
// 4. Sadece temel sinyaller
// 5. AAPL'de test edin ve kaç sinyal ürettiğini görün
// 6. Çalışırsa, sonra optimize ederiz
