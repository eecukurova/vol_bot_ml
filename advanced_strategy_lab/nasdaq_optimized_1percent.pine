//@version=5
strategy("NASDAQ Optimized %1", shorttitle="NASDAQ Opt", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ============================================================================
// OPTİMİZE EDİLMİŞ %1 KAR STRATEJİSİ (Python testlerinden)
// ============================================================================
a = input.float(0.5, "ATR Sensitivity", minval=0.1, maxval=2.0, step=0.1, group="Optimized Parameters")
c = input.int(2, "ATR Period", minval=1, maxval=10, group="Optimized Parameters")
st_factor = input.float(0.4, "SuperTrend Factor", minval=0.1, maxval=1.0, step=0.1, group="Optimized Parameters")

// Risk Management - Python testlerinde en iyi sonuçlar
take_profit_pct = input.float(1.0, "Take Profit %", minval=0.5, maxval=3.0, step=0.1, group="Risk Management")
stop_loss_pct = input.float(0.5, "Stop Loss %", minval=0.2, maxval=2.0, step=0.1, group="Risk Management")

// Sık işlem için minimum bekleme süresi
min_wait_bars = input.int(1, "Min Wait Bars", minval=1, maxval=5, group="Risk Management")

// ============================================================================
// ATR SUPER TREND CALCULATION
// ============================================================================
atr_value = ta.atr(c)
hl2_value = hl2

// SuperTrend calculation
super_trend_up = hl2_value - (a * atr_value)
super_trend_down = hl2_value + (st_factor * atr_value)

// SuperTrend direction
var float super_trend = na
var int super_trend_direction = na

if na(super_trend[1])
    super_trend := super_trend_up
    super_trend_direction := 1
else
    if super_trend_direction[1] == 1
        super_trend := math.max(super_trend_up, super_trend[1])
        super_trend_direction := super_trend == super_trend_up ? 1 : -1
    else
        super_trend := math.min(super_trend_down, super_trend[1])
        super_trend_direction := super_trend == super_trend_down ? -1 : 1

// ============================================================================
// SIGNAL GENERATION
// ============================================================================
buy_signal = close > super_trend and close[1] <= super_trend[1]
sell_signal = close < super_trend and close[1] >= super_trend[1]

// Son işlemden sonra minimum bekleme süresi
var int last_trade_bar = 0
can_trade = bar_index - last_trade_bar >= min_wait_bars

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================
if buy_signal and strategy.position_size == 0 and can_trade
    stop_loss_price = close * (1 - stop_loss_pct / 100)
    take_profit_price = close * (1 + take_profit_pct / 100)
    
    strategy.entry("BUY", strategy.long)
    strategy.exit("BUY Exit", "BUY", stop=stop_loss_price, limit=take_profit_price)
    last_trade_bar := bar_index

if sell_signal and strategy.position_size == 0 and can_trade
    stop_loss_price = close * (1 + stop_loss_pct / 100)
    take_profit_price = close * (1 - take_profit_pct / 100)
    
    strategy.entry("SELL", strategy.short)
    strategy.exit("SELL Exit", "SELL", stop=stop_loss_price, limit=take_profit_price)
    last_trade_bar := bar_index

// ============================================================================
// PLOTTING
// ============================================================================
// SuperTrend line
plot(super_trend, "SuperTrend", color=close > super_trend ? color.green : color.red, linewidth=2)

// Signal markers
plotshape(buy_signal and can_trade, "Buy Signal", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(sell_signal and can_trade, "Sell Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// ============================================================================
// PERFORMANCE INFORMATION
// ============================================================================
if barstate.islast
    var table perf_table = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)
    
    table.cell(perf_table, 0, 0, "Strategy", text_color=color.white, text_size=size.normal, bgcolor=color.green)
    table.cell(perf_table, 1, 0, "NASDAQ Optimized", text_color=color.white, text_size=size.normal, bgcolor=color.green)
    
    table.cell(perf_table, 0, 1, "Take Profit", text_color=color.black, text_size=size.small)
    table.cell(perf_table, 1, 1, str.tostring(take_profit_pct) + "%", text_color=color.black, text_size=size.small)
    
    table.cell(perf_table, 0, 2, "Stop Loss", text_color=color.black, text_size=size.small)
    table.cell(perf_table, 1, 2, str.tostring(stop_loss_pct) + "%", text_color=color.black, text_size=size.small)
    
    table.cell(perf_table, 0, 3, "ATR Sensitivity", text_color=color.black, text_size=size.small)
    table.cell(perf_table, 1, 3, str.tostring(a), text_color=color.black, text_size=size.small)
    
    table.cell(perf_table, 0, 4, "ATR Period", text_color=color.black, text_size=size.small)
    table.cell(perf_table, 1, 4, str.tostring(c), text_color=color.black, text_size=size.small)
    
    table.cell(perf_table, 0, 5, "SuperTrend Factor", text_color=color.black, text_size=size.small)
    table.cell(perf_table, 1, 5, str.tostring(st_factor), text_color=color.black, text_size=size.small)
    
    table.cell(perf_table, 0, 6, "Min Wait Bars", text_color=color.black, text_size=size.small)
    table.cell(perf_table, 1, 6, str.tostring(min_wait_bars), text_color=color.black, text_size=size.small)
    
    table.cell(perf_table, 0, 7, "Expected WR", text_color=color.black, text_size=size.small)
    table.cell(perf_table, 1, 7, "78.67%", text_color=color.black, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(buy_signal and can_trade, "NASDAQ Opt Buy", "NASDAQ Optimized: BUY signal")
alertcondition(sell_signal and can_trade, "NASDAQ Opt Sell", "NASDAQ Optimized: SELL signal")
