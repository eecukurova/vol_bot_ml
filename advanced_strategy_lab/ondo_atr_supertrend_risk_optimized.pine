//@version=5
strategy("ONDO ATR SuperTrend Risk Optimized", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=20)

// ============================================================================
// INPUT PARAMETERS - ONDO USDT RISK OPTIMIZED
// ============================================================================

// ATR Parameters - Risk optimized
atr_period = input.int(12, "ATR Period", minval=8, maxval=20)
atr_multiplier = input.float(3.0, "ATR Key Value (Sensitivity)", minval=2.0, maxval=4.0, step=0.1)
supertrend_multiplier = input.float(1.5, "SuperTrend Multiplier", minval=1.0, maxval=2.0, step=0.1)

// Heikin Ashi Option
use_heikin_ashi = input.bool(true, "Use Heikin Ashi Candles")

// Risk Management - Optimized for ONDO
stop_loss_pct = input.float(2.0, "Stop Loss (%)", minval=1.0, maxval=3.0, step=0.1) / 100
take_profit_pct = input.float(3.5, "Take Profit (%)", minval=2.0, maxval=6.0, step=0.1) / 100
trailing_stop = input.bool(true, "Enable Trailing Stop")
trailing_percent = input.float(1.0, "Trailing Stop (%)", minval=0.5, maxval=2.0, step=0.1) / 100

// Position Sizing - Dynamic
use_dynamic_sizing = input.bool(true, "Use Dynamic Position Sizing")
base_position_size = input.float(20, "Base Position Size (%)", minval=10, maxval=50, step=5)
max_position_size = input.float(35, "Max Position Size (%)", minval=20, maxval=60, step=5)
min_position_size = input.float(10, "Min Position Size (%)", minval=5, maxval=25, step=5)

// Volume Filter - Risk optimized
use_volume_filter = input.bool(true, "Use Volume Filter")
volume_multiplier = input.float(1.4, "Volume Multiplier", minval=1.2, maxval=2.0, step=0.1)

// Timeframe Filter - Risk optimized
use_timeframe_filter = input.bool(true, "Use Timeframe Filter")
start_hour = input.int(7, "Start Hour (UTC)", minval=0, maxval=23)
end_hour = input.int(22, "End Hour (UTC)", minval=0, maxval=23)

// Additional filters for risk management
use_rsi_filter = input.bool(true, "Use RSI Filter")
rsi_period = input.int(14, "RSI Period", minval=10, maxval=21)
rsi_oversold = input.int(35, "RSI Oversold", minval=25, maxval=45)
rsi_overbought = input.int(65, "RSI Overbought", minval=55, maxval=75)

// Volatility filter
use_volatility_filter = input.bool(true, "Use Volatility Filter")
volatility_period = input.int(20, "Volatility Period", minval=10, maxval=30)
max_volatility = input.float(0.05, "Max Volatility", minval=0.02, maxval=0.10, step=0.01)

// ============================================================================
// ATR SUPER TREND CALCULATIONS
// ============================================================================

// Source price (Heikin Ashi or regular)
src = use_heikin_ashi ? (open + high + low + close) / 4 : close

// ATR calculations
xATR = ta.atr(atr_period)
nLoss = atr_multiplier * xATR

// Trailing Stop calculations
var float xATRTrailingStop = na
xATRTrailingStop := na(xATRTrailingStop[1]) ? src - nLoss : 
   src > xATRTrailingStop[1] and src[1] > xATRTrailingStop[1] ? math.max(xATRTrailingStop[1], src - nLoss) :
   src < xATRTrailingStop[1] and src[1] < xATRTrailingStop[1] ? math.min(xATRTrailingStop[1], src + nLoss) :
   src > xATRTrailingStop[1] ? src - nLoss : src + nLoss

// Position tracking
var int pos = 0
pos := src[1] < xATRTrailingStop[1] and src > xATRTrailingStop[1] ? 1 :
       src[1] > xATRTrailingStop[1] and src < xATRTrailingStop[1] ? -1 : pos[1]

// Super Trend calculations
superTrend = xATR * supertrend_multiplier
trendUp = hl2 - superTrend
trendDown = hl2 + superTrend

var float superTrendLine = na
superTrendLine := na(superTrendLine[1]) ? na : 
   close > superTrendLine[1] ? math.max(trendUp, superTrendLine[1]) : math.min(trendDown, superTrendLine[1])
superTrendLine := na(superTrendLine) ? na : 
   close > superTrendLine ? trendDown : trendUp

// ============================================================================
// DYNAMIC POSITION SIZING
// ============================================================================

// Calculate volatility
volatility = ta.stdev(close, volatility_period) / close

// Calculate position size based on volatility and market conditions
position_size = use_dynamic_sizing ? 
   math.min(max_position_size, math.max(min_position_size, base_position_size * (1 - volatility * 10))) : 
   base_position_size

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// Basic signals
ema_fast = ta.ema(src, 1)
above_crossover = ta.crossover(ema_fast, xATRTrailingStop)
below_crossover = ta.crossover(xATRTrailingStop, ema_fast)

// ATR SuperTrend signals
buy_atr = src > xATRTrailingStop and above_crossover
sell_atr = src < xATRTrailingStop and below_crossover

// SuperTrend signals
buy_supertrend = ta.crossover(close, superTrendLine)
sell_supertrend = ta.crossunder(close, superTrendLine)

// ============================================================================
// FILTERS
// ============================================================================

// Volume filter
volume_condition = not use_volume_filter or volume > ta.sma(volume, 20) * volume_multiplier

// Timeframe filter
timeframe_condition = not use_timeframe_filter or (hour >= start_hour and hour <= end_hour)

// RSI filter
rsi = ta.rsi(close, rsi_period)
rsi_condition_long = not use_rsi_filter or rsi < rsi_overbought
rsi_condition_short = not use_rsi_filter or rsi > rsi_oversold

// Volatility filter
volatility_condition = not use_volatility_filter or volatility < max_volatility

// Combined filters
filters_ok_long = volume_condition and timeframe_condition and rsi_condition_long and volatility_condition
filters_ok_short = volume_condition and timeframe_condition and rsi_condition_short and volatility_condition

// ============================================================================
// FINAL ENTRY CONDITIONS
// ============================================================================

// Combined entry conditions
long_condition = (buy_atr or buy_supertrend) and filters_ok_long
short_condition = (sell_atr or sell_supertrend) and filters_ok_short

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Long positions
if long_condition and strategy.position_size == 0
    strategy.entry("Long", strategy.long, qty=position_size)
    if stop_loss_pct > 0
        strategy.exit("Long SL/TP", "Long", stop=close * (1 - stop_loss_pct), limit=close * (1 + take_profit_pct))

// Short positions
if short_condition and strategy.position_size == 0
    strategy.entry("Short", strategy.short, qty=position_size)
    if stop_loss_pct > 0
        strategy.exit("Short SL/TP", "Short", stop=close * (1 + stop_loss_pct), limit=close * (1 - take_profit_pct))

// Trailing stop
if trailing_stop and strategy.position_size != 0
    if strategy.position_size > 0
        strategy.exit("Long Trail", "Long", trail_price=close * (1 + trailing_percent), trail_offset=close * trailing_percent)
    else
        strategy.exit("Short Trail", "Short", trail_price=close * (1 - trailing_percent), trail_offset=close * trailing_percent)

// ============================================================================
// VISUALIZATION
// ============================================================================

// Plot SuperTrend line
plot(superTrendLine, color=color.blue, linewidth=2, title="SuperTrend Line")

// Plot ATR Trailing Stop
plot(xATRTrailingStop, color=pos == 1 ? color.green : color.red, linewidth=1, title="ATR Trailing Stop")

// Plot RSI
rsi_line = plot(use_rsi_filter ? rsi : na, color=color.purple, linewidth=1, title="RSI", display=display.data_window)

// Plot Volatility
volatility_line = plot(use_volatility_filter ? volatility * 100 : na, color=color.orange, linewidth=1, title="Volatility %", display=display.data_window)

// Plot signals
plotshape(long_condition, title="Long Signal", text="LONG", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, size=size.small)
plotshape(short_condition, title="Short Signal", text="SHORT", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, size=size.small)

// Bar coloring
barcolor(pos == 1 ? color.new(color.green, 80) : pos == -1 ? color.new(color.red, 80) : na, title="Trend Color")

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(long_condition, title="ONDO Long Signal", message="ONDO Long Signal - ATR SuperTrend Risk Optimized")
alertcondition(short_condition, title="ONDO Short Signal", message="ONDO Short Signal - ATR SuperTrend Risk Optimized")

// ============================================================================
// TABLE FOR PARAMETERS DISPLAY
// ============================================================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 14, bgcolor=color.white, border_width=1)
    table.cell(info_table, 0, 0, "Parameter", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 0, 1, "ATR Period", text_color=color.black)
    table.cell(info_table, 1, 1, str.tostring(atr_period), text_color=color.black)
    table.cell(info_table, 0, 2, "ATR Multiplier", text_color=color.black)
    table.cell(info_table, 1, 2, str.tostring(atr_multiplier), text_color=color.black)
    table.cell(info_table, 0, 3, "SuperTrend Mult", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(supertrend_multiplier), text_color=color.black)
    table.cell(info_table, 0, 4, "Stop Loss %", text_color=color.black)
    table.cell(info_table, 1, 4, str.tostring(stop_loss_pct * 100), text_color=color.black)
    table.cell(info_table, 0, 5, "Take Profit %", text_color=color.black)
    table.cell(info_table, 1, 5, str.tostring(take_profit_pct * 100), text_color=color.black)
    table.cell(info_table, 0, 6, "Position Size", text_color=color.black)
    table.cell(info_table, 1, 6, str.tostring(position_size) + "%", text_color=color.black)
    table.cell(info_table, 0, 7, "Volume Filter", text_color=color.black)
    table.cell(info_table, 1, 7, use_volume_filter ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 8, "RSI Filter", text_color=color.black)
    table.cell(info_table, 1, 8, use_rsi_filter ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 9, "Volatility Filter", text_color=color.black)
    table.cell(info_table, 1, 9, use_volatility_filter ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 10, "Dynamic Sizing", text_color=color.black)
    table.cell(info_table, 1, 10, use_dynamic_sizing ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 11, "Heikin Ashi", text_color=color.black)
    table.cell(info_table, 1, 11, use_heikin_ashi ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 12, "Current Volatility", text_color=color.black)
    table.cell(info_table, 1, 12, str.tostring(volatility * 100, "#.##") + "%", text_color=color.black)
    table.cell(info_table, 0, 13, "Risk Level", text_color=color.black)
    table.cell(info_table, 1, 13, volatility > max_volatility ? "HIGH" : "NORMAL", text_color=volatility > max_volatility ? color.red : color.green)
