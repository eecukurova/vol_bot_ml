//@version=5
strategy("ONDO ATR SuperTrend 1h Optimized", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=25)

// ============================================================================
// INPUT PARAMETERS - ONDO USDT 1H OPTIMIZED
// ============================================================================

// ATR Parameters - 1h optimized for ONDO
atr_period = input.int(14, "ATR Period", minval=10, maxval=20)
atr_multiplier = input.float(2.5, "ATR Key Value (Sensitivity)", minval=1.5, maxval=3.5, step=0.1)
supertrend_multiplier = input.float(1.2, "SuperTrend Multiplier", minval=0.8, maxval=1.8, step=0.1)

// Heikin Ashi Option
use_heikin_ashi = input.bool(true, "Use Heikin Ashi Candles")

// Risk Management - 1h optimized for ONDO
stop_loss_pct = input.float(2.5, "Stop Loss (%)", minval=1.5, maxval=4.0, step=0.1) / 100
take_profit_pct = input.float(4.0, "Take Profit (%)", minval=2.5, maxval=8.0, step=0.1) / 100
trailing_stop = input.bool(true, "Enable Trailing Stop")
trailing_percent = input.float(1.2, "Trailing Stop (%)", minval=0.8, maxval=2.0, step=0.1) / 100

// Volume Filter - 1h optimized
use_volume_filter = input.bool(true, "Use Volume Filter")
volume_multiplier = input.float(1.5, "Volume Multiplier", minval=1.2, maxval=2.5, step=0.1)

// Timeframe Filter - 1h optimized (more selective hours)
use_timeframe_filter = input.bool(true, "Use Timeframe Filter")
start_hour = input.int(8, "Start Hour (UTC)", minval=0, maxval=23)
end_hour = input.int(20, "End Hour (UTC)", minval=0, maxval=23)

// Additional filters for 1h
use_rsi_filter = input.bool(true, "Use RSI Filter")
rsi_period = input.int(21, "RSI Period", minval=14, maxval=30)
rsi_oversold = input.int(30, "RSI Oversold", minval=20, maxval=40)
rsi_overbought = input.int(70, "RSI Overbought", minval=60, maxval=80)

// MACD filter for 1h - ONDO optimized
use_macd_filter = input.bool(false, "Use MACD Filter")
macd_fast = input.int(12, "MACD Fast", minval=8, maxval=16)
macd_slow = input.int(26, "MACD Slow", minval=20, maxval=35)
macd_signal = input.int(9, "MACD Signal", minval=7, maxval=12)

// ============================================================================
// ATR SUPER TREND CALCULATIONS
// ============================================================================

// Source price (Heikin Ashi or regular)
src = use_heikin_ashi ? (open + high + low + close) / 4 : close

// ATR calculations
xATR = ta.atr(atr_period)
nLoss = atr_multiplier * xATR

// Trailing Stop calculations
var float xATRTrailingStop = na
xATRTrailingStop := na(xATRTrailingStop[1]) ? src - nLoss : 
   src > xATRTrailingStop[1] and src[1] > xATRTrailingStop[1] ? math.max(xATRTrailingStop[1], src - nLoss) :
   src < xATRTrailingStop[1] and src[1] < xATRTrailingStop[1] ? math.min(xATRTrailingStop[1], src + nLoss) :
   src > xATRTrailingStop[1] ? src - nLoss : src + nLoss

// Position tracking
var int pos = 0
pos := src[1] < xATRTrailingStop[1] and src > xATRTrailingStop[1] ? 1 :
       src[1] > xATRTrailingStop[1] and src < xATRTrailingStop[1] ? -1 : pos[1]

// Super Trend calculations
superTrend = xATR * supertrend_multiplier
trendUp = hl2 - superTrend
trendDown = hl2 + superTrend

var float superTrendLine = na
superTrendLine := na(superTrendLine[1]) ? na : 
   close > superTrendLine[1] ? math.max(trendUp, superTrendLine[1]) : math.min(trendDown, superTrendLine[1])
superTrendLine := na(superTrendLine) ? na : 
   close > superTrendLine ? trendDown : trendUp

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// Basic signals
ema_fast = ta.ema(src, 1)
above_crossover = ta.crossover(ema_fast, xATRTrailingStop)
below_crossover = ta.crossover(xATRTrailingStop, ema_fast)

// ATR SuperTrend signals
buy_atr = src > xATRTrailingStop and above_crossover
sell_atr = src < xATRTrailingStop and below_crossover

// SuperTrend signals
buy_supertrend = ta.crossover(close, superTrendLine)
sell_supertrend = ta.crossunder(close, superTrendLine)

// ============================================================================
// FILTERS
// ============================================================================

// Volume filter
volume_condition = not use_volume_filter or volume > ta.sma(volume, 20) * volume_multiplier

// Timeframe filter
timeframe_condition = not use_timeframe_filter or (hour >= start_hour and hour <= end_hour)

// RSI filter
rsi = ta.rsi(close, rsi_period)
rsi_condition_long = not use_rsi_filter or rsi < rsi_overbought
rsi_condition_short = not use_rsi_filter or rsi > rsi_oversold

// MACD filter
macd_line = ta.ema(close, macd_fast) - ta.ema(close, macd_slow)
macd_signal_line = ta.ema(macd_line, macd_signal)
macd_histogram = macd_line - macd_signal_line
macd_bullish = macd_line > macd_signal_line and macd_line[1] <= macd_signal_line[1]
macd_bearish = macd_line < macd_signal_line and macd_line[1] >= macd_signal_line[1]
macd_condition_long = not use_macd_filter or macd_bullish
macd_condition_short = not use_macd_filter or macd_bearish

// Combined filters
filters_ok_long = volume_condition and timeframe_condition and rsi_condition_long and macd_condition_long
filters_ok_short = volume_condition and timeframe_condition and rsi_condition_short and macd_condition_short

// ============================================================================
// FINAL ENTRY CONDITIONS
// ============================================================================

// Combined entry conditions
long_condition = (buy_atr or buy_supertrend) and filters_ok_long
short_condition = (sell_atr or sell_supertrend) and filters_ok_short

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Long positions
if long_condition and strategy.position_size == 0
    strategy.entry("Long", strategy.long)
    if stop_loss_pct > 0
        strategy.exit("Long SL/TP", "Long", stop=close * (1 - stop_loss_pct), limit=close * (1 + take_profit_pct))

// Short positions
if short_condition and strategy.position_size == 0
    strategy.entry("Short", strategy.short)
    if stop_loss_pct > 0
        strategy.exit("Short SL/TP", "Short", stop=close * (1 + stop_loss_pct), limit=close * (1 - take_profit_pct))

// Trailing stop
if trailing_stop and strategy.position_size != 0
    if strategy.position_size > 0
        strategy.exit("Long Trail", "Long", trail_price=close * (1 + trailing_percent), trail_offset=close * trailing_percent)
    else
        strategy.exit("Short Trail", "Short", trail_price=close * (1 - trailing_percent), trail_offset=close * trailing_percent)

// ============================================================================
// VISUALIZATION
// ============================================================================

// Plot SuperTrend line
plot(superTrendLine, color=color.blue, linewidth=2, title="SuperTrend Line")

// Plot ATR Trailing Stop
plot(xATRTrailingStop, color=pos == 1 ? color.green : color.red, linewidth=1, title="ATR Trailing Stop")

// Plot RSI
rsi_line = plot(use_rsi_filter ? rsi : na, color=color.purple, linewidth=1, title="RSI", display=display.data_window)

// Plot MACD
macd_plot = plot(use_macd_filter ? macd_line : na, color=color.orange, linewidth=1, title="MACD", display=display.data_window)
macd_signal_plot = plot(use_macd_filter ? macd_signal_line : na, color=color.yellow, linewidth=1, title="MACD Signal", display=display.data_window)

// Plot signals
plotshape(long_condition, title="Long Signal", text="LONG", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, size=size.small)
plotshape(short_condition, title="Short Signal", text="SHORT", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, size=size.small)

// Bar coloring
barcolor(pos == 1 ? color.new(color.green, 80) : pos == -1 ? color.new(color.red, 80) : na, title="Trend Color")

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(long_condition, title="ONDO 1h Long Signal", message="ONDO 1h Long Signal - ATR SuperTrend")
alertcondition(short_condition, title="ONDO 1h Short Signal", message="ONDO 1h Short Signal - ATR SuperTrend")

// ============================================================================
// TABLE FOR PARAMETERS DISPLAY
// ============================================================================

if barstate.islast
    var table info_table = table.new(position.top_right, 2, 12, bgcolor=color.white, border_width=1)
    table.cell(info_table, 0, 0, "Parameter", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, "Value", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 0, 1, "Timeframe", text_color=color.black)
    table.cell(info_table, 1, 1, "1h", text_color=color.black)
    table.cell(info_table, 0, 2, "ATR Period", text_color=color.black)
    table.cell(info_table, 1, 2, str.tostring(atr_period), text_color=color.black)
    table.cell(info_table, 0, 3, "ATR Multiplier", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(atr_multiplier), text_color=color.black)
    table.cell(info_table, 0, 4, "SuperTrend Mult", text_color=color.black)
    table.cell(info_table, 1, 4, str.tostring(supertrend_multiplier), text_color=color.black)
    table.cell(info_table, 0, 5, "Stop Loss %", text_color=color.black)
    table.cell(info_table, 1, 5, str.tostring(stop_loss_pct * 100), text_color=color.black)
    table.cell(info_table, 0, 6, "Take Profit %", text_color=color.black)
    table.cell(info_table, 1, 6, str.tostring(take_profit_pct * 100), text_color=color.black)
    table.cell(info_table, 0, 7, "Volume Filter", text_color=color.black)
    table.cell(info_table, 1, 7, use_volume_filter ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 8, "RSI Filter", text_color=color.black)
    table.cell(info_table, 1, 8, use_rsi_filter ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 9, "MACD Filter", text_color=color.black)
    table.cell(info_table, 1, 9, use_macd_filter ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 10, "Heikin Ashi", text_color=color.black)
    table.cell(info_table, 1, 10, use_heikin_ashi ? "ON" : "OFF", text_color=color.black)
    table.cell(info_table, 0, 11, "Position Size", text_color=color.black)
    table.cell(info_table, 1, 11, "25%", text_color=color.black)
