//@version=4
study(title="ATR SuperTrend Optimized", overlay=true)

// =========================
// INPUTS
// =========================
group_atr = "ATR Parameters"
a = input(3, title="Key Value (Sensitivity)", minval=0.1, maxval=10, step=0.1, group=group_atr)
c = input(10, title="ATR Period", minval=1, maxval=50, group=group_atr)
factor = input(1.5, title="SuperTrend Multiplier", minval=0.1, maxval=5, step=0.1, group=group_atr)

group_heikin = "Heikin Ashi"
h = input(false, title="Use Heikin Ashi Candles", group=group_heikin)

group_display = "Display"
show_atr_trailing = input(true, title="Show ATR Trailing Stop", group=group_display)
show_supertrend = input(true, title="Show SuperTrend Line", group=group_display)
show_signals = input(true, title="Show Buy/Sell Signals", group=group_display)

// =========================
// CALCULATIONS
// =========================

// Source: Heikin Ashi or Normal
src = h ? security(heikinashi(syminfo.tickerid), timeframe.period, close, lookahead=false) : close

// ATR calculations
xATR = atr(c)
nLoss = a * xATR

// ATR Trailing Stop calculations
xATRTrailingStop = 0.0
xATRTrailingStop := iff(src > nz(xATRTrailingStop[1], 0) and src[1] > nz(xATRTrailingStop[1], 0), 
                       max(nz(xATRTrailingStop[1]), src - nLoss),
                       iff(src < nz(xATRTrailingStop[1], 0) and src[1] < nz(xATRTrailingStop[1], 0), 
                           min(nz(xATRTrailingStop[1]), src + nLoss), 
                           iff(src > nz(xATRTrailingStop[1], 0), src - nLoss, src + nLoss)))

// Position tracking
pos = 0   
pos := iff(src[1] < nz(xATRTrailingStop[1], 0) and src > nz(xATRTrailingStop[1], 0), 1,
          iff(src[1] > nz(xATRTrailingStop[1], 0) and src < nz(xATRTrailingStop[1], 0), -1, nz(pos[1], 0))) 

// EMA(1) for crossover detection
ema1 = ema(src, 1)

// ATR Trailing Stop signals
above = crossover(ema1, xATRTrailingStop)
below = crossover(xATRTrailingStop, ema1)

buy_atr = src > xATRTrailingStop and above 
sell_atr = src < xATRTrailingStop and below

// SuperTrend calculations
superTrend = xATR * factor
trendUp = hl2 - superTrend
trendDown = hl2 + superTrend

var float superTrendLine = na
superTrendLine := na(superTrendLine[1]) ? na : (close > superTrendLine[1] ? max(trendUp, superTrendLine[1]) : min(trendDown, superTrendLine[1]))
superTrendLine := na(superTrendLine) ? na : (close > superTrendLine ? trendDown : trendUp)

// SuperTrend signals
buySuperTrend = crossover(close, superTrendLine)
sellSuperTrend = crossunder(close, superTrendLine)

// Combined signals (both strategies must agree)
buy_combined = buy_atr and buySuperTrend
sell_combined = sell_atr and sellSuperTrend

// Alternative: Use only ATR Trailing Stop (more sensitive)
buy_final = buy_atr
sell_final = sell_atr

// =========================
// PLOTS
// =========================

// ATR Trailing Stop
plot(show_atr_trailing ? xATRTrailingStop : na, title="ATR Trailing Stop", color=color.orange, linewidth=2)

// SuperTrend Line
plot(show_supertrend ? superTrendLine : na, title="SuperTrend", color=color.blue, linewidth=2)

// Buy/Sell signals
plotshape(show_signals and buy_final, title="Buy Signal", style=shape.triangleup, location=location.belowbar, 
          color=color.green, textcolor=color.white, size=size.small, text="BUY")
plotshape(show_signals and sell_final, title="Sell Signal", style=shape.triangledown, location=location.abovebar, 
          color=color.red, textcolor=color.white, size=size.small, text="SELL")

// Background color based on position
bgcolor(pos == 1 ? color.new(color.green, 90) : pos == -1 ? color.new(color.red, 90) : na, title="Trend Background")

// Bar coloring
barcolor(pos == 1 ? color.new(color.green, 80) : pos == -1 ? color.new(color.red, 80) : na, title="Bar Color")

// =========================
// ALERTS
// =========================
alertcondition(buy_final, title="ATR SuperTrend Buy", message="ATR SuperTrend: BUY Signal - {{ticker}}")
alertcondition(sell_final, title="ATR SuperTrend Sell", message="ATR SuperTrend: SELL Signal - {{ticker}}")

// =========================
// TABLE INFO
// =========================
var table info_table = table.new(position.top_right, 2, 6, frame_color=color.black, frame_width=1, border_width=0)

if barstate.islast
    table.cell(info_table, 0, 0, "Parameter", text_color=color.white, bgcolor=color.new(color.blue, 75))
    table.cell(info_table, 1, 0, "Value", text_color=color.white, bgcolor=color.new(color.blue, 75))
    
    table.cell(info_table, 0, 1, "Key Value (a)", text_color=color.white)
    table.cell(info_table, 1, 1, str.tostring(a), text_color=color.white)
    
    table.cell(info_table, 0, 2, "ATR Period (c)", text_color=color.white)
    table.cell(info_table, 1, 2, str.tostring(c), text_color=color.white)
    
    table.cell(info_table, 0, 3, "SuperTrend Factor", text_color=color.white)
    table.cell(info_table, 1, 3, str.tostring(factor), text_color=color.white)
    
    table.cell(info_table, 0, 4, "Heikin Ashi", text_color=color.white)
    table.cell(info_table, 1, 4, h ? "ON" : "OFF", text_color=color.white)
    
    table.cell(info_table, 0, 5, "Current Position", text_color=color.white)
    table.cell(info_table, 1, 5, pos == 1 ? "BULLISH" : pos == -1 ? "BEARISH" : "NEUTRAL", 
               text_color=pos == 1 ? color.green : pos == -1 ? color.red : color.gray)
