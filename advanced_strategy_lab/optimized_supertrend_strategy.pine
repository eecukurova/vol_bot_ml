//@version=5
strategy("Optimized SUPERTREND Strategy", overlay=true, margin_long=100, margin_short=100)

// Optimized Parameters from Python Backtest
atr_period = input.int(7, title="ATR Period", minval=1)
atr_multiplier = input.float(0.6, title="ATR Multiplier", minval=0.1, step=0.1)
stop_loss_pct = input.float(0.5, title="Stop Loss %", minval=0.1, step=0.1)
take_profit_pct = input.float(1.0, title="Take Profit %", minval=0.1, step=0.1)

// ATR Calculation
atr_value = ta.atr(atr_period)

// SuperTrend Calculation
hl2 = (high + low) / 2
upper_band = hl2 + (atr_multiplier * atr_value)
lower_band = hl2 - (atr_multiplier * atr_value)

var float super_trend = na
var int trend = 1

prev_super_trend = super_trend[1]
prev_trend = trend[1]

if na(atr_value[1])
    super_trend := lower_band
    trend := 1
else
    if prev_trend == 1
        super_trend := lower_band > prev_super_trend ? lower_band : prev_super_trend
    else
        super_trend := upper_band < prev_super_trend ? upper_band : prev_super_trend

    if close > super_trend
        trend := 1
    else if close < super_trend
        trend := -1
    else
        trend := prev_trend

// Plot SuperTrend
plot(super_trend, title="SuperTrend", color=trend == 1 ? color.green : color.red, linewidth=2)

// Trading Logic
long_condition = ta.crossover(close, super_trend)
short_condition = ta.crossunder(close, super_trend)

// Entry Orders
if long_condition
    strategy.entry("Long", strategy.long, comment="BUY")
    
if short_condition
    strategy.entry("Short", strategy.short, comment="SELL")

// Exit Orders with optimized parameters
if strategy.position_size > 0
    stop_price = strategy.position_avg_price * (1 - stop_loss_pct / 100)
    profit_price = strategy.position_avg_price * (1 + take_profit_pct / 100)
    strategy.exit("Long Exit", "Long", stop=stop_price, limit=profit_price, comment="SL/TP")

if strategy.position_size < 0
    stop_price = strategy.position_avg_price * (1 + stop_loss_pct / 100)
    profit_price = strategy.position_avg_price * (1 - take_profit_pct / 100)
    strategy.exit("Short Exit", "Short", stop=stop_price, limit=profit_price, comment="SL/TP")

// Background color based on trend
bgcolor(trend == 1 ? color.new(color.green, 95) : color.new(color.red, 95), title="Trend Background")

// Alerts
alertcondition(long_condition, title="Long Signal", message="SUPERTREND Long Signal")
alertcondition(short_condition, title="Short Signal", message="SUPERTREND Short Signal")

// Table with strategy info
var table info_table = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(info_table, 0, 0, "Strategy", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 0, "Optimized SUPERTREND", text_color=color.black, text_size=size.small)
    table.cell(info_table, 0, 1, "ATR Period", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 1, str.tostring(atr_period), text_color=color.black, text_size=size.small)
    table.cell(info_table, 0, 2, "ATR Multiplier", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 2, str.tostring(atr_multiplier), text_color=color.black, text_size=size.small)
    table.cell(info_table, 0, 3, "SL/TP", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 3, str.tostring(stop_loss_pct) + "%/" + str.tostring(take_profit_pct) + "%", text_color=color.black, text_size=size.small)
